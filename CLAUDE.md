# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Explico Learning is a modern TypeScript/React-based interactive walkthrough editor that compiles to Google Apps Script. It allows users to create hotspot-enabled presentations with background media (images, videos, YouTube). The app features a project dashboard and hotspot editor with real-time preview capabilities, all persisted to Google Sheets. The project has been migrated from plain JavaScript to TypeScript with React components for better maintainability and type safety.

**Live URLs:**
- Web App: https://script.google.com/macros/s/AKfycbw9ZicNfjF7nSt_lCpYoI3MXEi_McVLAW3dzBClcTVz-QgsJ_nPDTRsQA0ELCK5fyde/exec
- Apps Script Editor: https://script.google.com/d/1YiQsdE97f3dM50Y26dgjqPUCjIIbMGWX5U2yVha8fu1264DtIj0VJWh_/edit

## Development Commands

### Deployment

#### Quick Deployment with Claude Command
```bash
# Complete workflow: build → push → update deployment (recommended)
/clasp

# Just build the project
/clasp build

# Build and push (no deploy)
/clasp push

# Just update current deployment
/clasp redeploy
```

#### TypeScript Deployment Commands
```bash
# Production deployment: quality checks + build + push + update active deployment
npm run deploy

# Development deployment: build + push + update active deployment (skip quality checks)
npm run deploy:dev

# Create NEW deployment (new URL - use sparingly)
npm run deploy-new

# Just push code without deploying (for testing)
npm run deploy-push-only
```

#### Manual Deployment Commands
```bash
# Build project files (copies to dist/)
./build.sh

# Push code changes to Google Apps Script
clasp push --force

# Deploy new version
clasp deploy --description "Version description"

# Update existing deployment (recommended)
clasp deploy --deploymentId "DEPLOYMENT_ID" --description "Updated version"

# View deployments
clasp deployments

# Open Apps Script editor
clasp open
```

### File Structure
- `src/` - TypeScript source code
  - `src/client/` - React components and client-side TypeScript
  - `src/server/` - Server-side TypeScript that compiles to Google Apps Script
  - `src/shared/` - Shared types, constants, and utilities
- `dist/` - Built files ready for deployment (generated by webpack + build.sh)
- `services/` - Legacy JavaScript services (being migrated)
- `templates/` - HTML templates
- `Code.gs` - Main server-side entry point (generated from src/server/Code.ts)
- `constants.gs` - Application constants (generated from src/server/constants.ts)
- `package.json` - NPM dependencies and build scripts
- `webpack.config.js` - Webpack configuration for TypeScript compilation
- `tsconfig.json` - TypeScript configuration
- `appsscript.json` - Google Apps Script project configuration
- `.clasp.json` - Deployment configuration (script ID, root dir)

## Architecture

### Modern TypeScript/React Architecture
The application follows a modern component-based architecture with TypeScript type safety:

**Server-Side TypeScript (`src/server/`):**
- `Code.ts` - Main server-side entry point and routing (compiles to Code.gs)
- `constants.ts` - Application constants and configuration (compiles to constants.gs)
- `services/` - Server-side service classes

**Client-Side React Components (`src/client/`):**
- `components/ProjectDashboard.tsx` - Project management dashboard
- `components/AppHeader.tsx` - Application header with save/share functionality
- `components/Sidebar.tsx` - Slide navigation with drag-and-drop reordering
- `components/MainCanvas.tsx` - Interactive preview canvas with hotspot rendering
- `components/ConfigPanel.tsx` - Dynamic hotspot configuration forms
- `components/HotspotEditor.tsx` - Hotspot creation and editing interface
- `components/common/` - Reusable components (modals, loading spinners, error boundaries)

**Legacy Services (being migrated from `services/`):**
- `GoogleSheetsAPI.js` - Data persistence layer with Google Sheets integration
- `HotspotManager.js` - Manages hotspot CRUD operations
- `EventTypeHandlers.js` - Handles different hotspot event types
- `MediaHandler.js` - Processes background media
- `ProjectManager_server.js` - Server-side project management
- `ProjectManager_client.js` - Client-side project management

**Shared Code (`src/shared/`):**
- `types/` - TypeScript interfaces and type definitions
- `constants/` - Shared constants
- `utils/` - Utility functions

### Data Storage Structure
Each project creates a Google Spreadsheet with sheets:
- **Projects** - Project metadata, settings, analytics
- **Slides** - Slide data, media URLs, ordering  
- **Hotspots** - Complete hotspot configurations with positioning and events
- **Analytics** - User interaction tracking and metrics

### Page Routing
The main `Code.gs` file (compiled from `src/server/Code.ts`) handles web app routing:
- `/exec` (default) → `main-app.html` - Project management interface (React-based)
- `/exec?page=editor&project={id}` → `editor-template.html` - Hotspot creation/editing interface (React-based)

## Component Integration Flow

### Project Loading
1. User selects project → `ProjectManager.openProject()`
2. Load slides from sheets → Update `Sidebar` component  
3. Select first slide → `HotspotManager.setActiveSlide()`
4. Load hotspots and media → Update `MainCanvas` and `ConfigPanel`
5. Sync all components for real-time editing

### Hotspot Creation
1. User clicks canvas → `HotspotManager.createHotspot()`
2. Update `MainCanvas` → `HotspotRenderer.createHotspot()` 
3. Update `ConfigPanel` → Show hotspot settings
4. Update `WalkthroughSequencer` → Add to timeline
5. Auto-save → `GoogleSheetsAPI.saveHotspots()`

### Real-time Synchronization
Components communicate through callback functions for real-time updates:
- Canvas ↔ ConfigPanel ↔ Sequencer stay synchronized
- All changes are debounced and auto-saved to Google Sheets
- Service layer coordinates component updates to prevent conflicts

## Key Configuration Files

### src/server/constants.ts (compiles to constants.gs)
Contains all application constants including:
- `EVENT_TYPES` - Hotspot event types (text_popup, pan_zoom, spotlight, text_on_image)
- `TRIGGER_TYPES` - User interaction types (click, hover, touch)
- `HOTSPOT_DEFAULTS` - Default hotspot configuration
- `SHEETS_CONFIG` - Google Sheets column mappings
- `VALIDATION_RULES` - Form validation rules
- `UI_CONFIG` - Layout dimensions, breakpoints, z-index layers

### package.json
- NPM dependencies for TypeScript, React, Webpack
- Build scripts for development and production
- Testing and linting configurations
- Deployment scripts with quality checks

### appsscript.json
- OAuth scopes for Google Sheets, Drive, and user email access
- Runtime version and webapp execution settings
- External request permissions for YouTube API integration

## Development Guidelines

### TypeScript Development Workflow
1. **Source code**: Edit TypeScript files in `src/`
2. **Build**: Run `npm run build` or `npm run build:dev`
3. **Type checking**: `npm run type-check`
4. **Linting**: `npm run lint`
5. **Testing**: `npm run test`
6. **Deploy**: `npm run deploy` or `npm run deploy:dev`

### Adding New React Components
1. Create new `.tsx` file in `src/client/components/`
2. Follow existing TypeScript/React patterns
3. Use shared types from `src/shared/types/`
4. Import constants from `src/shared/constants/`
5. Add proper TypeScript interfaces
6. Export component from appropriate index file

### Adding New Hotspot Event Types
1. Add event type constant to `EVENT_TYPES` in `src/shared/constants/`
2. Update TypeScript interfaces in `src/shared/types/`
3. Implement handler in legacy `EventTypeHandlers.js` (to be migrated)
4. Add configuration form controls in `ConfigPanel.tsx`
5. Update hotspot rendering components
6. Test with real-time preview in editor

### Migration Strategy (Legacy → TypeScript)
- **Legacy services** in `services/` are being gradually migrated to TypeScript
- **Priority**: Client-side components (React) → Server-side services → Utilities
- **Maintain compatibility** during migration
- **Test thoroughly** after each migration step

### Google Sheets Integration
- Each project gets its own spreadsheet for data isolation
- Use batch operations in `GoogleSheetsAPI.gs` for performance
- Column mappings defined in `SHEETS_CONFIG` constants
- Relationship integrity maintained through service layer

### Testing and Validation
- Test in Google Apps Script environment (not local)
- Validate OAuth permissions in deployed webapp
- Test with multiple projects and large datasets
- Verify component synchronization in real-time editing scenarios
- **Always test frontend functionality using Playwright MCP** after deployments
- **Always check Context7 MCP for library updates** before making changes
- **When performing web searches, prioritize recent information** - Look for content from 2025 and late 2024 to ensure you're getting the most current documentation, best practices, and compatibility information

## Deployment Notes

- Always run `./build.sh` before pushing changes
- Use `clasp push --force` to overwrite remote files
- Deploy new versions with descriptive messages
- Test deployed webapp after each deployment
- Monitor Google Apps Script execution logs for errors

## Recent Fixes (2025-09-02)

### Fixed: Spreadsheet Creation Issue
**Problem**: App was stalling when loading project IDs because spreadsheets weren't being created properly.

**Root Cause**: The `GoogleSheetsAPI.gs` service was using `SpreadsheetApp.getActiveSpreadsheet()` which doesn't work in web app context. Only works when script is bound to a specific spreadsheet.

**Solution**: Updated `GoogleSheetsAPI.gs` to use `SpreadsheetApp.openById(spreadsheetId)` like `Code.gs` does, and added robust spreadsheet structure initialization.

**Changes Made**:
1. **Fixed GoogleSheetsAPI.gs** - Replaced all `getActiveSpreadsheet()` calls with `openById(this.options.spreadsheetId)`
2. **Enhanced Code.gs** - Added `ensureSpreadsheetStructure()` function that creates missing sheets and headers for existing projects
3. **Added setupSheetHeaders()** - Helper function to create proper headers for each sheet type
4. **Improved getProjectData()** - Now automatically initializes spreadsheet structure and creates default project records if missing

**Files Changed**:
- `GoogleSheetsAPI.gs` - Fixed spreadsheet access pattern
- `Code.gs` - Added structure validation and auto-repair

After deployment, existing project spreadsheets will be automatically upgraded with proper structure when accessed.

## Build Process

### Webpack Compilation
1. **TypeScript compilation**: `src/` → JavaScript bundles
2. **React compilation**: TSX components → JavaScript
3. **Code generation**: TypeScript → Google Apps Script compatible code
4. **HTML template processing**: Inline compiled JavaScript into HTML templates

### Build Script (`build.sh`)
Copies compiled files to `dist/`:
- `Code.gs` (compiled from `src/server/Code.ts`)
- `constants.gs` (compiled from `src/server/constants.ts`)
- `main-app.html` (React app with inlined JavaScript)
- `editor-template.html` (React editor with inlined JavaScript)
- `appsscript.json` (project configuration)

### Development vs Production
- **Development**: Fast builds, source maps, debug mode
- **Production**: Minified, optimized, type-checked, linted, tested