# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Explico Learning is a Google Apps Script-based interactive walkthrough editor that allows users to create hotspot-enabled presentations with background media (images, videos, YouTube). The app features a project dashboard and hotspot editor with real-time preview capabilities, all persisted to Google Sheets.

**Live URLs:**
- Web App: https://script.google.com/macros/s/AKfycbw9ZicNfjF7nSt_lCpYoI3MXEi_McVLAW3dzBClcTVz-QgsJ_nPDTRsQA0ELCK5fyde/exec
- Apps Script Editor: https://script.google.com/d/1YiQsdE97f3dM50Y26dgjqPUCjIIbMGWX5U2yVha8fu1264DtIj0VJWh_/edit

## Development Commands

### Deployment

#### Quick Deployment with Claude Command
```bash
# Complete workflow: build → push → update deployment (recommended)
/clasp

# Just build the project
/clasp build

# Build and push (no deploy)
/clasp push

# Just update current deployment
/clasp redeploy
```

#### TypeScript Deployment Commands
```bash
# Production deployment: quality checks + build + push + update active deployment
npm run deploy

# Development deployment: build + push + update active deployment (skip quality checks)
npm run deploy:dev

# Create NEW deployment (new URL - use sparingly)
npm run deploy-new

# Just push code without deploying (for testing)
npm run deploy-push-only
```

#### Manual Deployment Commands
```bash
# Build project files (copies to dist/)
./build.sh

# Push code changes to Google Apps Script
clasp push --force

# Deploy new version
clasp deploy --description "Version description"

# Update existing deployment (recommended)
clasp deploy --deploymentId "DEPLOYMENT_ID" --description "Updated version"

# View deployments
clasp deployments

# Open Apps Script editor
clasp open
```

### File Structure
- `dist/` - Built files ready for deployment (generated by build.sh)
- `Code.gs` - Main server-side entry point and routing
- `constants.gs` - Application constants and configuration
- `*.gs` files - Service classes and UI components (Google Apps Script)
- `*.html` files - HTML templates and UI pages
- `appsscript.json` - Google Apps Script project configuration
- `.clasp.json` - Deployment configuration (script ID, root dir)

## Architecture

### Service-Oriented Architecture
The application follows a service-oriented pattern with clear separation of concerns:

**Core Services (`.gs` files):**
- `ProjectManager.gs` - Master orchestrator, coordinates all services and manages project lifecycle
- `HotspotManager.gs` - Manages hotspot CRUD operations and real-time synchronization
- `EventTypeHandlers.gs` - Handles different hotspot event types (text popup, pan/zoom, spotlight)
- `MediaHandler.gs` - Processes background media (images, videos, YouTube URLs)  
- `GoogleSheetsAPI.gs` - Data persistence layer with Google Sheets integration

**UI Components (`.gs` files):**
- `AppHeader.gs` - Application header with save/share functionality
- `Sidebar.gs` - Slide navigation with drag-and-drop reordering
- `MainCanvas.gs` - Interactive preview canvas with hotspot rendering
- `ConfigPanel.gs` - Dynamic hotspot configuration forms
- `WalkthroughSequencer.gs` - Hotspot timeline and sequence management
- `ProjectDashboard.gs` - Project management dashboard
- `HotspotRenderer.gs` - Hotspot visualization engine

**Support Components:**
- `FormControls.gs` - Reusable form controls (inputs, toggles, sliders)
- `StatusBadge.gs`, `ProgressBar.gs` - Status indicators and progress visualization

### Data Storage Structure
Each project creates a Google Spreadsheet with sheets:
- **Projects** - Project metadata, settings, analytics
- **Slides** - Slide data, media URLs, ordering  
- **Hotspots** - Complete hotspot configurations with positioning and events
- **Analytics** - User interaction tracking and metrics

### Page Routing
The main `Code.gs` file handles web app routing:
- `/exec` (default) → `project-dashboard.html` - Project management interface
- `/exec?page=editor&project={id}` → `hotspot-editor.html` - Hotspot creation/editing

## Component Integration Flow

### Project Loading
1. User selects project → `ProjectManager.openProject()`
2. Load slides from sheets → Update `Sidebar` component  
3. Select first slide → `HotspotManager.setActiveSlide()`
4. Load hotspots and media → Update `MainCanvas` and `ConfigPanel`
5. Sync all components for real-time editing

### Hotspot Creation
1. User clicks canvas → `HotspotManager.createHotspot()`
2. Update `MainCanvas` → `HotspotRenderer.createHotspot()` 
3. Update `ConfigPanel` → Show hotspot settings
4. Update `WalkthroughSequencer` → Add to timeline
5. Auto-save → `GoogleSheetsAPI.saveHotspots()`

### Real-time Synchronization
Components communicate through callback functions for real-time updates:
- Canvas ↔ ConfigPanel ↔ Sequencer stay synchronized
- All changes are debounced and auto-saved to Google Sheets
- Service layer coordinates component updates to prevent conflicts

## Key Configuration Files

### constants.gs
Contains all application constants including:
- `EVENT_TYPES` - Hotspot event types (text_popup, pan_zoom, spotlight, text_on_image)  
- `TRIGGER_TYPES` - User interaction types (click, hover, touch)
- `HOTSPOT_DEFAULTS` - Default hotspot configuration
- `SHEETS_CONFIG` - Google Sheets column mappings
- `VALIDATION_RULES` - Form validation rules
- `UI_CONFIG` - Layout dimensions, breakpoints, z-index layers

### appsscript.json
- OAuth scopes for Google Sheets, Drive, and user email access
- Runtime version and webapp execution settings
- External request permissions for YouTube API integration

## Development Guidelines

### Adding New Hotspot Event Types
1. Add event type constant to `EVENT_TYPES` in `constants.gs`
2. Implement handler in `EventTypeHandlers.gs`
3. Add configuration form controls in `ConfigPanel.gs`
4. Update hotspot rendering in `HotspotRenderer.gs`
5. Test with real-time preview in editor

### Adding New UI Components
Follow the existing component pattern:
1. Create class-based component in `.gs` file
2. Implement `render()` method returning HTML string
3. Add event handling and state management methods
4. Register with `ProjectManager` for coordination
5. Add corresponding `.html` file for complex templates

### Google Sheets Integration
- Each project gets its own spreadsheet for data isolation
- Use batch operations in `GoogleSheetsAPI.gs` for performance
- Column mappings defined in `SHEETS_CONFIG` constants
- Relationship integrity maintained through service layer

### Testing and Validation
- Test in Google Apps Script environment (not local)
- Validate OAuth permissions in deployed webapp
- Test with multiple projects and large datasets
- Verify component synchronization in real-time editing scenarios
- **Always test frontend functionality using Playwright MCP** after deployments
- **Always check Context7 MCP for library updates** before making changes
- **When performing web searches, prioritize recent information** - Look for content from 2025 and late 2024 to ensure you're getting the most current documentation, best practices, and compatibility information

## Deployment Notes

- Always run `./build.sh` before pushing changes
- Use `clasp push --force` to overwrite remote files
- Deploy new versions with descriptive messages
- Test deployed webapp after each deployment
- Monitor Google Apps Script execution logs for errors

## Recent Fixes (2025-09-02)

### Fixed: Spreadsheet Creation Issue
**Problem**: App was stalling when loading project IDs because spreadsheets weren't being created properly.

**Root Cause**: The `GoogleSheetsAPI.gs` service was using `SpreadsheetApp.getActiveSpreadsheet()` which doesn't work in web app context. Only works when script is bound to a specific spreadsheet.

**Solution**: Updated `GoogleSheetsAPI.gs` to use `SpreadsheetApp.openById(spreadsheetId)` like `Code.gs` does, and added robust spreadsheet structure initialization.

**Changes Made**:
1. **Fixed GoogleSheetsAPI.gs** - Replaced all `getActiveSpreadsheet()` calls with `openById(this.options.spreadsheetId)`
2. **Enhanced Code.gs** - Added `ensureSpreadsheetStructure()` function that creates missing sheets and headers for existing projects
3. **Added setupSheetHeaders()** - Helper function to create proper headers for each sheet type
4. **Improved getProjectData()** - Now automatically initializes spreadsheet structure and creates default project records if missing

**Files Changed**:
- `GoogleSheetsAPI.gs` - Fixed spreadsheet access pattern
- `Code.gs` - Added structure validation and auto-repair

After deployment, existing project spreadsheets will be automatically upgraded with proper structure when accessed.

## File Dependencies

The build script copies these files to `dist/`:
- `Code.gs` (main entry point)
- `constants.gs` (configuration)  
- `*.html` (all HTML templates)
- `appsscript.json` (project config)

All other `.gs` files are standalone components that work together through the service architecture.