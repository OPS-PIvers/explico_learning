<script>
/**
 * ProjectDashboard Component for Explico Learning
 * Dashboard for managing and displaying walkthrough projects
 */

class ProjectDashboard {
  
  constructor(options = {}) {
    this.options = {
      projects: [],
      searchQuery: '',
      sortBy: 'updatedAt',
      sortOrder: 'desc',
      showFilters: true,
      showSearch: true,
      showCreateButton: true,
      onProjectSelect: null,
      onProjectCreate: null,
      onProjectEdit: null,
      onProjectDelete: null,
      onProjectDuplicate: null,
      onSearchChange: null,
      ...options
    };
    
    this.element = null;
    this.filteredProjects = [];
  }
  
  /**
   * Create and return the dashboard element
   * @returns {HTMLElement} Dashboard element
   */
  render() {
    this.element = document.createElement('main');
    this.element.className = 'project-dashboard flex-1';
    
    // Header section
    const header = this.createHeader();
    this.element.appendChild(header);
    
    // Content section
    const content = this.createContent();
    this.element.appendChild(content);
    
    // Initialize filtered projects
    this.updateFilteredProjects();
    
    return this.element;
  }
  
  /**
   * Create dashboard header
   * @returns {HTMLElement} Header element
   */
  createHeader() {
    const header = document.createElement('header');
    header.className = 'dashboard-header flex h-20 items-center justify-between border-b border-gray-700/50 bg-gray-900/50 px-10';
    
    // Left section - Title
    const leftSection = document.createElement('div');
    leftSection.className = 'header-left';
    
    const title = document.createElement('h2');
    title.className = 'text-2xl font-bold text-white';
    title.textContent = 'Expli.co Learning';
    
    leftSection.appendChild(title);
    header.appendChild(leftSection);
    
    // Right section - Actions
    const rightSection = document.createElement('div');
    rightSection.className = 'header-right flex items-center gap-6';
    
    // Search input
    if (this.options.showSearch) {
      const searchContainer = this.createSearchInput();
      rightSection.appendChild(searchContainer);
    }
    
    // Create button
    if (this.options.showCreateButton) {
      const createButton = this.createNewProjectButton();
      rightSection.appendChild(createButton);
    }
    
    // Notification button
    const notificationButton = this.createNotificationButton();
    rightSection.appendChild(notificationButton);
    
    // User avatar
    const userAvatar = this.createUserAvatar();
    rightSection.appendChild(userAvatar);
    
    header.appendChild(rightSection);
    
    return header;
  }
  
  /**
   * Create search input
   * @returns {HTMLElement} Search container element
   */
  createSearchInput() {
    const container = document.createElement('div');
    container.className = 'search-container relative flex-1 max-w-sm';
    
    const icon = document.createElement('span');
    icon.className = 'material-icons absolute left-3 top-1/2 -translate-y-1/2 text-gray-400';
    icon.textContent = 'search';
    
    const input = document.createElement('input');
    input.className = 'w-full rounded-full border-gray-700 bg-gray-800/60 py-2 pl-10 pr-4 text-sm text-white placeholder:text-gray-400 focus:border-[var(--brand-primary)] focus:ring-[var(--brand-primary)]';
    input.type = 'text';
    input.placeholder = 'Search walkthroughs...';
    input.value = this.options.searchQuery;
    input.id = 'project-search';
    
    input.addEventListener('input', (e) => {
      this.setSearchQuery(e.target.value);
    });
    
    container.appendChild(icon);
    container.appendChild(input);
    
    return container;
  }
  
  /**
   * Create new project button
   * @returns {HTMLElement} Create button element
   */
  createNewProjectButton() {
    const button = document.createElement('button');
    button.className = 'flex items-center gap-2 rounded-full px-4 py-2 text-sm font-bold text-[var(--text-primary)] transition-colors';
    button.style.backgroundColor = 'var(--brand-primary)';
    button.id = 'new-project-button';
    
    const icon = document.createElement('span');
    icon.className = 'material-icons';
    icon.textContent = 'add';
    
    const text = document.createElement('span');
    text.textContent = 'New Walkthrough';
    
    button.appendChild(icon);
    button.appendChild(text);
    
    button.addEventListener('click', () => {
      if (this.options.onProjectCreate) {
        this.options.onProjectCreate();
      }
    });
    
    return button;
  }
  
  /**
   * Create notification button
   * @returns {HTMLElement} Notification button element
   */
  createNotificationButton() {
    const button = document.createElement('button');
    button.className = 'relative';
    
    const icon = document.createElement('span');
    icon.className = 'material-icons text-[var(--gray-light)] hover:text-white transition-colors';
    icon.textContent = 'notifications';
    
    button.appendChild(icon);
    
    // Add notification badge
    const badge = StatusBadge.createCountBadge({
      count: 3,
      size: 'sm'
    });
    
    if (badge) {
      badge.className += ' absolute -top-1 -right-1';
      button.appendChild(badge);
    }
    
    return button;
  }
  
  /**
   * Create user avatar
   * @returns {HTMLElement} User avatar element
   */
  createUserAvatar() {
    const avatar = document.createElement('div');
    avatar.className = 'h-10 w-10 rounded-full bg-cover bg-center bg-no-repeat cursor-pointer hover:ring-2 hover:ring-gray-500 transition-all';
    avatar.style.backgroundImage = 'url("https://lh3.googleusercontent.com/aida-public/AB6AXuCbH-S6o4W9BCYts8ETvD0aHB0dJM5A9VAS2aJgpWWIESb7KHiCvRHLtr8OjikMyZJgx04tP6Aohvo_JFOWiyWaGke_oYlW87CAYv8-Iihr9HTyA-VBd_q2tcxncDiNIIZSFqhQVp0ixYtoNREA_uEhBwkqqnpC-PoLa4GwJIgaqI2qGyuiD4mCn97MwplW3sqti_XFUy6v_TN5yFaiGuoP0PpHCXfMZw0h2OGsSY12a-4goaUtx_L-jqpzKtFHulNTcyibcJyT8pg")';
    
    return avatar;
  }
  
  /**
   * Create content section
   * @returns {HTMLElement} Content element
   */
  createContent() {
    const content = document.createElement('div');
    content.className = 'dashboard-content p-10';
    
    // Content header
    const contentHeader = this.createContentHeader();
    content.appendChild(contentHeader);
    
    // Projects table
    const projectsTable = this.createProjectsTable();
    content.appendChild(projectsTable);
    
    return content;
  }
  
  /**
   * Create content header with title and filters
   * @returns {HTMLElement} Content header element
   */
  createContentHeader() {
    const header = document.createElement('div');
    header.className = 'content-header mb-8';
    
    // Title and description
    const titleSection = document.createElement('div');
    titleSection.className = 'title-section mb-4';
    
    const title = document.createElement('h3');
    title.className = 'text-2xl font-bold text-white';
    title.textContent = 'My Walkthroughs';
    
    const description = document.createElement('p');
    description.className = 'text-[var(--gray-light)]';
    description.textContent = 'Manage your existing walkthroughs or create new ones.';
    
    titleSection.appendChild(title);
    titleSection.appendChild(description);
    header.appendChild(titleSection);
    
    // Filters (if enabled)
    if (this.options.showFilters) {
      const filtersSection = this.createFiltersSection();
      header.appendChild(filtersSection);
    }
    
    return header;
  }
  
  /**
   * Create filters section
   * @returns {HTMLElement} Filters section element
   */
  createFiltersSection() {
    const section = document.createElement('div');
    section.className = 'filters-section flex items-center gap-4';
    
    // Sort dropdown
    const sortSelect = FormControls.createSelect({
      id: 'sort-select',
      label: '',
      value: `${this.options.sortBy}_${this.options.sortOrder}`,
      options: [
        { value: 'updatedAt_desc', label: 'Recently Updated' },
        { value: 'updatedAt_asc', label: 'Oldest First' },
        { value: 'name_asc', label: 'Name A-Z' },
        { value: 'name_desc', label: 'Name Z-A' },
        { value: 'views_desc', label: 'Most Views' },
        { value: 'completionRate_desc', label: 'Highest Completion Rate' }
      ],
      onChange: (value) => this.setSorting(value)
    });
    
    // Status filter
    const statusSelect = FormControls.createSelect({
      id: 'status-filter',
      label: '',
      value: 'all',
      options: [
        { value: 'all', label: 'All Projects' },
        { value: PROJECT_STATUS.ACTIVE, label: 'Active Only' },
        { value: PROJECT_STATUS.INACTIVE, label: 'Inactive Only' },
        { value: PROJECT_STATUS.DRAFT, label: 'Drafts Only' }
      ],
      onChange: (value) => this.setStatusFilter(value)
    });
    
    section.appendChild(sortSelect);
    section.appendChild(statusSelect);
    
    return section;
  }
  
  /**
   * Create projects table
   * @returns {HTMLElement} Projects table element
   */
  createProjectsTable() {
    const tableContainer = document.createElement('div');
    tableContainer.className = 'table-container overflow-hidden rounded-xl border border-gray-700/50 bg-gray-900/50 shadow-sm';
    
    const table = document.createElement('table');
    table.className = 'projects-table w-full text-sm';
    table.id = 'projects-table';
    
    // Table header
    const thead = this.createTableHeader();
    table.appendChild(thead);
    
    // Table body
    const tbody = this.createTableBody();
    table.appendChild(tbody);
    
    tableContainer.appendChild(table);
    
    return tableContainer;
  }
  
  /**
   * Create table header
   * @returns {HTMLElement} Table header element
   */
  createTableHeader() {
    const thead = document.createElement('thead');
    thead.className = 'bg-gray-800/60';
    
    const row = document.createElement('tr');
    
    const headers = [
      { text: 'Name', sortKey: 'name' },
      { text: 'Status', sortKey: 'status' },
      { text: 'Last Modified', sortKey: 'updatedAt' },
      { text: 'Views', sortKey: 'views' },
      { text: 'Completion Rate', sortKey: 'completionRate' },
      { text: 'Actions', sortKey: null }
    ];
    
    headers.forEach(header => {
      const th = document.createElement('th');
      th.className = 'px-6 py-4 text-left font-medium text-gray-400';
      
      if (header.sortKey) {
        th.className += ' cursor-pointer hover:text-white transition-colors';
        th.addEventListener('click', () => {
          this.toggleSort(header.sortKey);
        });
        
        // Add sort indicator if this column is sorted
        if (this.options.sortBy === header.sortKey) {
          const indicator = document.createElement('span');
          indicator.className = 'ml-1 material-icons text-xs';
          indicator.textContent = this.options.sortOrder === 'desc' ? 'arrow_drop_down' : 'arrow_drop_up';
          th.appendChild(document.createTextNode(header.text));
          th.appendChild(indicator);
        } else {
          th.textContent = header.text;
        }
      } else {
        th.textContent = header.text;
        th.className += ' text-right';
      }
      
      row.appendChild(th);
    });
    
    thead.appendChild(row);
    return thead;
  }
  
  /**
   * Create table body
   * @returns {HTMLElement} Table body element
   */
  createTableBody() {
    const tbody = document.createElement('tbody');
    tbody.className = 'divide-y divide-gray-700/50';
    tbody.id = 'projects-tbody';
    
    // Render project rows
    this.renderProjectRows(tbody);
    
    return tbody;
  }
  
  /**
   * Render project rows in table body
   * @param {HTMLElement} tbody - Table body element
   */
  renderProjectRows(tbody) {
    tbody.innerHTML = '';
    
    if (this.filteredProjects.length === 0) {
      this.renderEmptyState(tbody);
      return;
    }
    
    this.filteredProjects.forEach(project => {
      const row = this.createProjectRow(project);
      tbody.appendChild(row);
    });
  }
  
  /**
   * Render empty state when no projects found
   * @param {HTMLElement} tbody - Table body element
   */
  renderEmptyState(tbody) {
    const row = document.createElement('tr');
    const cell = document.createElement('td');
    cell.colSpan = 6;
    cell.className = 'px-6 py-12 text-center';
    
    const emptyState = document.createElement('div');
    emptyState.className = 'flex flex-col items-center';
    
    const icon = document.createElement('span');
    icon.className = 'material-icons text-4xl text-gray-500 mb-4';
    icon.textContent = 'folder_open';
    
    const title = document.createElement('h3');
    title.className = 'text-lg font-medium text-gray-300 mb-2';
    title.textContent = this.options.searchQuery ? 'No projects found' : 'No walkthroughs yet';
    
    const description = document.createElement('p');
    description.className = 'text-sm text-gray-400 mb-4';
    description.textContent = this.options.searchQuery 
      ? 'Try adjusting your search terms or filters'
      : 'Create your first walkthrough to get started';
    
    emptyState.appendChild(icon);
    emptyState.appendChild(title);
    emptyState.appendChild(description);
    
    if (!this.options.searchQuery) {
      const createButton = document.createElement('button');
      createButton.className = 'btn btn-primary';
      createButton.textContent = 'Create Walkthrough';
      createButton.addEventListener('click', () => {
        if (this.options.onProjectCreate) {
          this.options.onProjectCreate();
        }
      });
      emptyState.appendChild(createButton);
    }
    
    cell.appendChild(emptyState);
    row.appendChild(cell);
    tbody.appendChild(row);
  }
  
  /**
   * Create project row
   * @param {Object} project - Project data
   * @returns {HTMLElement} Table row element
   */
  createProjectRow(project) {
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-800/60 transition-colors cursor-pointer';
    row.dataset.projectId = project.id;
    
    // Name column
    const nameCell = document.createElement('td');
    nameCell.className = 'px-6 py-4 font-medium text-white';
    nameCell.textContent = project.name || 'Untitled Project';
    row.appendChild(nameCell);
    
    // Status column
    const statusCell = document.createElement('td');
    statusCell.className = 'px-6 py-4';
    const statusBadge = StatusBadge.create({
      status: project.status || PROJECT_STATUS.DRAFT
    });
    statusCell.appendChild(statusBadge);
    row.appendChild(statusCell);
    
    // Last modified column
    const modifiedCell = document.createElement('td');
    modifiedCell.className = 'px-6 py-4 text-[var(--gray-light)]';
    modifiedCell.textContent = this.formatDate(project.updatedAt || project.createdAt);
    row.appendChild(modifiedCell);
    
    // Views column
    const viewsCell = document.createElement('td');
    viewsCell.className = 'px-6 py-4 text-[var(--gray-light)]';
    viewsCell.textContent = this.formatNumber(project.analytics?.views || 0);
    row.appendChild(viewsCell);
    
    // Completion rate column
    const completionCell = document.createElement('td');
    completionCell.className = 'px-6 py-4';
    const completionRate = project.analytics?.completionRate || 0;
    const progressBar = ProgressBar.create({
      value: completionRate,
      size: 'sm',
      showLabel: true
    });
    completionCell.appendChild(progressBar);
    row.appendChild(completionCell);
    
    // Actions column
    const actionsCell = document.createElement('td');
    actionsCell.className = 'px-6 py-4 text-right';
    const actionsButton = this.createActionsButton(project);
    actionsCell.appendChild(actionsButton);
    row.appendChild(actionsCell);
    
    // Row click handler
    row.addEventListener('click', (e) => {
      // Don't trigger if clicking on actions button
      if (!e.target.closest('.actions-button')) {
        if (this.options.onProjectSelect) {
          this.options.onProjectSelect(project);
        }
      }
    });
    
    return row;
  }
  
  /**
   * Create actions button (three-dot menu)
   * @param {Object} project - Project data
   * @returns {HTMLElement} Actions button element
   */
  createActionsButton(project) {
    const button = document.createElement('button');
    button.className = 'actions-button text-[var(--gray-light)] hover:text-white transition-colors p-1 rounded';
    
    const icon = document.createElement('span');
    icon.className = 'material-icons';
    icon.textContent = 'more_vert';
    
    button.appendChild(icon);
    
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      this.showProjectActionsMenu(e, project);
    });
    
    return button;
  }
  
  /**
   * Show project actions context menu
   * @param {MouseEvent} event - Click event
   * @param {Object} project - Project data
   */
  showProjectActionsMenu(event, project) {
    // Remove existing menu
    const existingMenu = document.querySelector('.project-actions-menu');
    if (existingMenu) {
      existingMenu.remove();
    }
    
    const menu = document.createElement('div');
    menu.className = 'project-actions-menu absolute bg-gray-800 border border-gray-600 rounded-md shadow-lg py-1 z-50 min-w-[150px]';
    menu.style.left = `${event.pageX - 100}px`;
    menu.style.top = `${event.pageY}px`;
    
    const menuItems = [
      { text: 'Open', icon: 'open_in_new', action: () => this.options.onProjectSelect?.(project) },
      { text: 'Edit', icon: 'edit', action: () => this.options.onProjectEdit?.(project) },
      { text: 'Duplicate', icon: 'content_copy', action: () => this.options.onProjectDuplicate?.(project) },
      { text: 'Export', icon: 'download', action: () => this.exportProject(project) },
      { text: 'Share', icon: 'share', action: () => this.shareProject(project) },
      { separator: true },
      { text: 'Delete', icon: 'delete', action: () => this.options.onProjectDelete?.(project), className: 'text-red-400 hover:bg-red-900/20' }
    ];
    
    menuItems.forEach(item => {
      if (item.separator) {
        const separator = document.createElement('div');
        separator.className = 'h-px bg-gray-600 my-1';
        menu.appendChild(separator);
        return;
      }
      
      const menuItem = document.createElement('button');
      menuItem.className = `flex items-center gap-3 w-full text-left px-3 py-2 text-sm text-white hover:bg-gray-700 transition-colors ${item.className || ''}`;
      
      const icon = document.createElement('span');
      icon.className = 'material-icons text-base';
      icon.textContent = item.icon;
      
      const text = document.createElement('span');
      text.textContent = item.text;
      
      menuItem.appendChild(icon);
      menuItem.appendChild(text);
      
      menuItem.addEventListener('click', () => {
        item.action();
        menu.remove();
      });
      
      menu.appendChild(menuItem);
    });
    
    document.body.appendChild(menu);
    
    // Remove on outside click
    const removeMenu = (e) => {
      if (!menu.contains(e.target)) {
        menu.remove();
        document.removeEventListener('click', removeMenu);
      }
    };
    
    setTimeout(() => {
      document.addEventListener('click', removeMenu);
    }, 0);
  }
  
  /**
   * Set search query and update filtered projects
   * @param {string} query - Search query
   */
  setSearchQuery(query) {
    this.options.searchQuery = query;
    this.updateFilteredProjects();
    
    if (this.options.onSearchChange) {
      this.options.onSearchChange(query);
    }
  }
  
  /**
   * Set sorting parameters
   * @param {string} value - Sort value in format "field_order"
   */
  setSorting(value) {
    const [field, order] = value.split('_');
    this.options.sortBy = field;
    this.options.sortOrder = order;
    this.updateFilteredProjects();
    this.updateTableHeader();
  }
  
  /**
   * Toggle sort order for a field
   * @param {string} field - Field to sort by
   */
  toggleSort(field) {
    if (this.options.sortBy === field) {
      this.options.sortOrder = this.options.sortOrder === 'asc' ? 'desc' : 'asc';
    } else {
      this.options.sortBy = field;
      this.options.sortOrder = 'desc';
    }
    
    this.updateFilteredProjects();
    this.updateTableHeader();
  }
  
  /**
   * Set status filter
   * @param {string} status - Status to filter by
   */
  setStatusFilter(status) {
    this.statusFilter = status;
    this.updateFilteredProjects();
  }
  
  /**
   * Update filtered and sorted projects
   */
  updateFilteredProjects() {
    let filtered = [...this.options.projects];
    
    // Apply search filter
    if (this.options.searchQuery) {
      const query = this.options.searchQuery.toLowerCase();
      filtered = filtered.filter(project => 
        (project.name || '').toLowerCase().includes(query) ||
        (project.description || '').toLowerCase().includes(query)
      );
    }
    
    // Apply status filter
    if (this.statusFilter && this.statusFilter !== 'all') {
      filtered = filtered.filter(project => project.status === this.statusFilter);
    }
    
    // Apply sorting
    filtered.sort((a, b) => {
      let aValue = a[this.options.sortBy];
      let bValue = b[this.options.sortBy];
      
      // Handle nested analytics properties
      if (this.options.sortBy === 'views' || this.options.sortBy === 'completionRate') {
        aValue = a.analytics?.[this.options.sortBy] || 0;
        bValue = b.analytics?.[this.options.sortBy] || 0;
      }
      
      // Handle dates
      if (this.options.sortBy === 'updatedAt' || this.options.sortBy === 'createdAt') {
        aValue = new Date(aValue || 0);
        bValue = new Date(bValue || 0);
      }
      
      // Handle strings
      if (typeof aValue === 'string') {
        aValue = aValue.toLowerCase();
        bValue = (bValue || '').toLowerCase();
      }
      
      let comparison = 0;
      if (aValue < bValue) comparison = -1;
      if (aValue > bValue) comparison = 1;
      
      return this.options.sortOrder === 'desc' ? -comparison : comparison;
    });
    
    this.filteredProjects = filtered;
    
    // Re-render table body
    const tbody = this.element?.querySelector('#projects-tbody');
    if (tbody) {
      this.renderProjectRows(tbody);
    }
  }
  
  /**
   * Update table header with current sort indicators
   */
  updateTableHeader() {
    const thead = this.element?.querySelector('thead');
    if (thead) {
      thead.remove();
      const newThead = this.createTableHeader();
      this.element?.querySelector('#projects-table')?.appendChild(newThead);
    }
  }
  
  /**
   * Format date for display
   * @param {string|Date} date - Date to format
   * @returns {string} Formatted date string
   */
  formatDate(date) {
    if (!date) return 'Never';
    
    const dateObj = new Date(date);
    const now = new Date();
    const diffMs = now - dateObj;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
    
    return dateObj.toLocaleDateString();
  }
  
  /**
   * Format number for display
   * @param {number} num - Number to format
   * @returns {string} Formatted number string
   */
  formatNumber(num) {
    if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;
    if (num >= 1000) return `${(num / 1000).toFixed(1)}K`;
    return num.toString();
  }
  
  /**
   * Export project (placeholder)
   * @param {Object} project - Project to export
   */
  exportProject(project) {
    console.log('Exporting project:', project.id);
    // TODO: Implement export functionality
  }
  
  /**
   * Share project (placeholder)
   * @param {Object} project - Project to share
   */
  shareProject(project) {
    console.log('Sharing project:', project.id);
    // TODO: Implement share functionality
  }
  
  /**
   * Set projects data
   * @param {Array} projects - Array of project objects
   */
  setProjects(projects) {
    this.options.projects = projects;
    this.updateFilteredProjects();
  }
  
  /**
   * Add project to list
   * @param {Object} project - Project to add
   */
  addProject(project) {
    this.options.projects.unshift(project); // Add to beginning
    this.updateFilteredProjects();
  }
  
  /**
   * Remove project from list
   * @param {string} projectId - Project ID to remove
   */
  removeProject(projectId) {
    this.options.projects = this.options.projects.filter(p => p.id !== projectId);
    this.updateFilteredProjects();
  }
  
  /**
   * Update project in list
   * @param {string} projectId - Project ID to update
   * @param {Object} updates - Project updates
   */
  updateProject(projectId, updates) {
    const index = this.options.projects.findIndex(p => p.id === projectId);
    if (index !== -1) {
      this.options.projects[index] = { ...this.options.projects[index], ...updates };
      this.updateFilteredProjects();
    }
  }
  
  /**
   * Get current projects
   * @returns {Array} Array of project objects
   */
  getProjects() {
    return this.options.projects;
  }
  
  /**
   * Get filtered projects
   * @returns {Array} Array of filtered project objects
   */
  getFilteredProjects() {
    return this.filteredProjects;
  }
  
  /**
   * Destroy the component
   */
  destroy() {
    if (this.element) {
      this.element.remove();
      this.element = null;
    }
  }
  
  /**
   * Get dashboard element
   * @returns {HTMLElement|null} Dashboard element
   */
  getElement() {
    return this.element;
  }
}
</script>