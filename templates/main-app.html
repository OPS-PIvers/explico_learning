<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Dashboard - Explico Learning</title>
    
    <!-- Preconnect to external services -->
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    
    <!-- Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Spline+Sans:wght@400;500;700" onload="this.rel='stylesheet'">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <!-- Base Styles -->
    <?!= include('styles'); ?>
</head>
<body class="bg-[var(--bg-primary)] font-primary">
    <!-- Application Container -->
    <div id="app" class="app-container min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center">
                        <h1 class="text-3xl font-bold text-gray-900">Explico Learning</h1>
                        <div class="ml-4 flex items-center">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                                Dashboard
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2 text-sm text-gray-600">
                            <span class="material-symbols-outlined text-sm">account_circle</span>
                            <span id="user-email">{{USER_EMAIL}}</span>
                        </div>
                        <button id="new-project-btn" class="btn btn-primary">
                            <span class="material-symbols-outlined text-sm">add</span>
                            New Project
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <span class="material-symbols-outlined text-2xl text-blue-600">folder</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Projects</p>
                            <p id="total-projects" class="text-2xl font-bold text-gray-900">{{TOTAL_PROJECTS}}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <span class="material-symbols-outlined text-2xl text-green-600">slideshow</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Slides</p>
                            <p id="total-slides" class="text-2xl font-bold text-gray-900">{{TOTAL_SLIDES}}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <span class="material-symbols-outlined text-2xl text-purple-600">radio_button_checked</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Hotspots</p>
                            <p id="total-hotspots" class="text-2xl font-bold text-gray-900">{{TOTAL_HOTSPOTS}}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <span class="material-symbols-outlined text-2xl text-orange-600">schedule</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Last Updated</p>
                            <p id="last-updated" class="text-sm font-semibold text-gray-900">{{LAST_UPDATED}}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter Bar -->
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-3 sm:space-y-0">
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm">search</span>
                            <input 
                                type="text" 
                                id="search-projects" 
                                placeholder="Search projects..." 
                                class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>
                        <select id="filter-status" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">All Projects</option>
                            <option value="draft">Draft</option>
                            <option value="published">Published</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="sort-btn" class="btn btn-outline">
                            <span class="material-symbols-outlined text-sm">sort</span>
                            Sort
                        </button>
                        <button id="refresh-btn" class="btn btn-outline">
                            <span class="material-symbols-outlined text-sm">refresh</span>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Projects Grid -->
            <div id="projects-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Project cards will be dynamically populated -->
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="text-center py-12 hidden">
                <div class="mx-auto h-24 w-24 text-gray-400">
                    <span class="material-symbols-outlined text-6xl">folder_open</span>
                </div>
                <h3 class="mt-4 text-lg font-medium text-gray-900">No projects found</h3>
                <p class="mt-2 text-sm text-gray-500">Get started by creating your first walkthrough project.</p>
                <button id="empty-new-project-btn" class="mt-4 btn btn-primary">
                    <span class="material-symbols-outlined text-sm">add</span>
                    Create New Project
                </button>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="text-center py-12">
                <div class="mx-auto h-8 w-8 animate-spin text-blue-600">
                    <span class="material-symbols-outlined text-2xl">refresh</span>
                </div>
                <p class="mt-2 text-sm text-gray-500">Loading projects...</p>
            </div>
        </main>
    </div>

    <!-- New Project Modal -->
    <div id="new-project-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Create New Project</h3>
            </div>
            <form id="new-project-form" class="px-6 py-4 space-y-4">
                <div>
                    <label for="project-name" class="block text-sm font-medium text-gray-700 mb-1">Project Name</label>
                    <input 
                        type="text" 
                        id="project-name" 
                        name="projectName"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Enter project name..."
                        required
                    >
                </div>
                <div>
                    <label for="project-description" class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                    <textarea 
                        id="project-description" 
                        name="projectDescription"
                        rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Brief description of your walkthrough..."
                    ></textarea>
                </div>
            </form>
            <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                <button id="cancel-new-project" class="btn btn-outline">Cancel</button>
                <button id="create-new-project" class="btn btn-primary">Create Project</button>
            </div>
        </div>
    </div>
    
    
    
    <!-- Utility Components -->
    <?!= include('js_FormControls'); ?>
    <?!= include('js_StatusBadge'); ?>
    <?!= include('js_ProgressBar'); ?>
    <?!= include('js_ProjectDashboard'); ?>
    
    <!-- Business Logic Services -->
    <?!= include('js_GoogleSheetsAPI'); ?>
    <?!= include('js_ProjectManager'); ?>
    
    <!-- Google Apps Script Integration -->
    <script>
        // Global app state
        window.ExplicoApp = {
            projectManager: null,
            dashboard: null,
            initialized: false,
            projects: [],
            filteredProjects: []
        };
        
        // Initialize error handling
        window.addEventListener('error', function(event) {
            console.error('Dashboard error:', event.error);
            // TODO: Send error to analytics
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            // TODO: Send error to analytics
        });
        
        // Helper function to call Google Apps Script functions
        function callGoogleFunction(functionName, ...args) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    [functionName](...args);
            });
        }
        
        // Dashboard-specific GAS functions
        function getCurrentUser() {
            return callGoogleFunction('getCurrentUser');
        }
        
        function getUserProjects() {
            return callGoogleFunction('getUserProjects');
        }
        
        function createNewProject(projectData) {
            return callGoogleFunction('createNewProject', projectData);
        }
        
        function deleteProject(projectId) {
            return callGoogleFunction('deleteProject', projectId);
        }
        
        function duplicateProject(projectId) {
            return callGoogleFunction('duplicateProject', projectId);
        }
        
        function updateProjectMetadata(projectId, metadata) {
            return callGoogleFunction('updateProjectMetadata', projectId, metadata);
        }
        
        // Initialize dashboard application
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize services
                const projectManager = new ProjectManager();
                await projectManager.initialize({
                    sheetsAPI: new GoogleSheetsAPI()
                });
                
                // Initialize dashboard component
                const dashboard = new ProjectDashboard(document.getElementById('projects-container'));
                
                // Store global references
                window.ExplicoApp.projectManager = projectManager;
                window.ExplicoApp.dashboard = dashboard;
                
                // Load projects
                await loadProjects();
                
                // Setup event listeners
                setupEventListeners();
                
                window.ExplicoApp.initialized = true;
                console.log('Dashboard application initialized successfully');
                
            } catch (error) {
                console.error('Failed to initialize dashboard:', error);
                showError('Failed to initialize dashboard: ' + error.message);
            }
        });
        
        // Load projects from Google Sheets
        async function loadProjects() {
            try {
                document.getElementById('loading-state').classList.remove('hidden');
                document.getElementById('empty-state').classList.add('hidden');
                
                const projects = await getUserProjects();
                window.ExplicoApp.projects = projects;
                window.ExplicoApp.filteredProjects = projects;
                
                if (projects.length === 0) {
                    document.getElementById('empty-state').classList.remove('hidden');
                    document.getElementById('projects-container').classList.add('hidden');
                } else {
                    document.getElementById('empty-state').classList.add('hidden');
                    document.getElementById('projects-container').classList.remove('hidden');
                    window.ExplicoApp.dashboard.renderProjects(projects);
                }
                
                // Update stats
                updateDashboardStats(projects);
                
            } catch (error) {
                console.error('Error loading projects:', error);
                showError('Failed to load projects: ' + error.message);
            } finally {
                document.getElementById('loading-state').classList.add('hidden');
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // New project buttons
            document.getElementById('new-project-btn').addEventListener('click', () => {
                document.getElementById('new-project-modal').classList.remove('hidden');
                document.getElementById('new-project-modal').classList.add('flex');
                document.getElementById('project-name').focus();
            });
            
            document.getElementById('empty-new-project-btn').addEventListener('click', () => {
                document.getElementById('new-project-modal').classList.remove('hidden');
                document.getElementById('new-project-modal').classList.add('flex');
                document.getElementById('project-name').focus();
            });
            
            // Modal controls
            document.getElementById('cancel-new-project').addEventListener('click', closeNewProjectModal);
            document.getElementById('create-new-project').addEventListener('click', handleCreateProject);
            
            // Close modal on overlay click
            document.getElementById('new-project-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('new-project-modal')) {
                    closeNewProjectModal();
                }
            });
            
            // Search and filter
            document.getElementById('search-projects').addEventListener('input', handleSearch);
            document.getElementById('filter-status').addEventListener('change', handleFilter);
            document.getElementById('refresh-btn').addEventListener('click', loadProjects);
            
            // Form submission
            document.getElementById('new-project-form').addEventListener('submit', (e) => {
                e.preventDefault();
                handleCreateProject();
            });
        }
        
        // Handle project creation
        async function handleCreateProject() {
            try {
                const form = document.getElementById('new-project-form');
                const formData = new FormData(form);
                
                const projectData = {
                    name: formData.get('projectName').trim(),
                    description: formData.get('projectDescription').trim(),
                    createdAt: new Date().toISOString(),
                    status: 'draft'
                };
                
                if (!projectData.name) {
                    alert('Please enter a project name');
                    return;
                }
                
                document.getElementById('create-new-project').disabled = true;
                document.getElementById('create-new-project').textContent = 'Creating...';
                
                const newProject = await createNewProject(projectData);
                
                closeNewProjectModal();
                
                // Navigate to editor
                window.location.href = `hotspot-editor.html?project=${newProject.id}`;
                
            } catch (error) {
                console.error('Error creating project:', error);
                alert('Failed to create project: ' + error.message);
            } finally {
                document.getElementById('create-new-project').disabled = false;
                document.getElementById('create-new-project').textContent = 'Create Project';
            }
        }
        
        // Close new project modal
        function closeNewProjectModal() {
            document.getElementById('new-project-modal').classList.add('hidden');
            document.getElementById('new-project-modal').classList.remove('flex');
            document.getElementById('new-project-form').reset();
        }
        
        // Handle search
        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            filterProjects();
        }
        
        // Handle filter
        function handleFilter(e) {
            filterProjects();
        }
        
        // Filter projects based on search and status
        function filterProjects() {
            const query = document.getElementById('search-projects').value.toLowerCase();
            const status = document.getElementById('filter-status').value;
            
            let filtered = window.ExplicoApp.projects;
            
            if (query) {
                filtered = filtered.filter(project => 
                    project.name.toLowerCase().includes(query) ||
                    (project.description && project.description.toLowerCase().includes(query))
                );
            }
            
            if (status) {
                filtered = filtered.filter(project => project.status === status);
            }
            
            window.ExplicoApp.filteredProjects = filtered;
            
            if (filtered.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('projects-container').classList.add('hidden');
            } else {
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('projects-container').classList.remove('hidden');
                window.ExplicoApp.dashboard.renderProjects(filtered);
            }
        }
        
        // Update dashboard statistics
        function updateDashboardStats(projects) {
            const totalProjects = projects.length;
            const totalSlides = projects.reduce((sum, project) => sum + (project.slideCount || 0), 0);
            const totalHotspots = projects.reduce((sum, project) => sum + (project.hotspotCount || 0), 0);
            const lastUpdated = projects.length > 0 
                ? new Date(Math.max(...projects.map(p => new Date(p.updatedAt || p.createdAt)))).toLocaleDateString()
                : 'N/A';
            
            document.getElementById('total-projects').textContent = totalProjects;
            document.getElementById('total-slides').textContent = totalSlides;
            document.getElementById('total-hotspots').textContent = totalHotspots;
            document.getElementById('last-updated').textContent = lastUpdated;
        }
        
        // Show error message
        function showError(message) {
            // Create error notification
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded shadow-lg z-50';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <span class="material-symbols-outlined text-sm mr-2">error</span>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-red-500 hover:text-red-700">
                        <span class="material-symbols-outlined text-sm">close</span>
                    </button>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>