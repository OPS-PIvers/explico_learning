<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{PROJECT_NAME}} - Hotspot Editor - Explico Learning</title>
    
    
    <!-- Preconnect to external services -->
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    
    <!-- Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Spline+Sans:wght@400;500;700" onload="this.rel='stylesheet'">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,">
    
    <!-- Suppress Tailwind CDN production warning BEFORE loading Tailwind -->
    <script>
        // Override console.warn to filter Tailwind production warnings
        const originalWarn = console.warn;
        console.warn = function(...args) {
            const message = args.join(' ');
            if (message.includes('cdn.tailwindcss.com should not be used in production')) {
                return; // Suppress this specific warning
            }
            originalWarn.apply(console, args);
        };
    </script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        // Suppress Tailwind CDN production warning for Google Apps Script environment
        tailwind.config = {
            corePlugins: {
                preflight: false,
            }
        };
    </script>
    
    <!-- Base Styles -->
    <?!= HtmlService.createHtmlOutputFromFile('styles').getContent(); ?>
</head>
<body class="bg-[var(--bg-primary)] font-primary">
    <!-- Application Container -->
    <div id="app" class="app-container flex flex-col min-h-screen">
        <!-- Header -->
        <header id="app-header" class="flex-shrink-0 bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <h1 class="text-2xl font-bold text-gray-900">{{PROJECT_NAME}}</h1>
                        <div class="ml-4 flex items-center space-x-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                Editor
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="save-btn" class="btn btn-primary">
                            <span class="material-symbols-outlined text-sm">save</span>
                            Save Project
                        </button>
                        <button id="preview-btn" class="btn btn-secondary">
                            <span class="material-symbols-outlined text-sm">play_arrow</span>
                            Preview
                        </button>
                        <button id="back-to-dashboard-btn" class="btn btn-outline">
                            <span class="material-symbols-outlined text-sm">arrow_back</span>
                            Back to Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-80 bg-white border-r border-gray-200 flex-shrink-0 overflow-y-auto">
                <!-- Sidebar content will be dynamically populated -->
            </aside>

            <!-- Main Content -->
            <main class="flex-1 flex overflow-hidden">
                <!-- Canvas Area -->
                <div id="canvas-container" class="flex-1 bg-gray-50 relative overflow-hidden">
                    <!-- Canvas content will be dynamically populated -->
                </div>

                <!-- Config Panel -->
                <aside id="config-panel" class="w-96 bg-white border-l border-gray-200 flex-shrink-0 overflow-y-auto hidden">
                    <!-- Config panel content will be dynamically populated -->
                </aside>
            </main>
        </div>

        <!-- Bottom Timeline/Sequencer -->
        <div id="sequencer-container" class="h-32 bg-white border-t border-gray-200 flex-shrink-0">
            <!-- Sequencer content will be dynamically populated -->
        </div>
    </div>
    
    <!-- Core Constants -->
    <script>
        <?!= HtmlService.createHtmlOutputFromFile('constants').getContent(); ?>
    </script>
    
    <!-- Utility Components -->
    <script>
        <?!= HtmlService.createHtmlOutputFromFile('FormControls').getContent(); ?>
        <?!= HtmlService.createHtmlOutputFromFile('StatusBadge').getContent(); ?>
        <?!= HtmlService.createHtmlOutputFromFile('ProgressBar').getContent(); ?>
        <?!= HtmlService.createHtmlOutputFromFile('HotspotRenderer').getContent(); ?>
    </script>
    
    <!-- Layout Components -->
    <script>
        <?!= HtmlService.createHtmlOutputFromFile('AppHeader').getContent(); ?>
        <?!= HtmlService.createHtmlOutputFromFile('Sidebar').getContent(); ?>
        <?!= HtmlService.createHtmlOutputFromFile('MainCanvas').getContent(); ?>
        <?!= HtmlService.createHtmlOutputFromFile('ConfigPanel').getContent(); ?>
        <?!= HtmlService.createHtmlOutputFromFile('WalkthroughSequencer').getContent(); ?>
    </script>
    
    <!-- Business Logic Services -->
    <script>
        <?!= HtmlService.createHtmlOutputFromFile('services/GoogleSheetsAPI').getContent(); ?>
        <?!= HtmlService.createHtmlOutputFromFile('services/MediaHandler').getContent(); ?>
        <?!= HtmlService.createHtmlOutputFromFile('services/EventTypeHandlers').getContent(); ?>
        <?!= HtmlService.createHtmlOutputFromFile('services/HotspotManager').getContent(); ?>
        <?!= HtmlService.createHtmlOutputFromFile('services/ProjectManager').getContent(); ?>
    </script>
    
    <!-- Google Apps Script Integration -->
    <script>
        // Global app state
        window.ExplicoApp = {
            projectManager: null,
            components: {},
            initialized: false,
            currentProject: null,
            currentSlide: null
        };
        
        // Initialize error handling
        window.addEventListener('error', function(event) {
            console.error('Editor error:', event.error);
            // TODO: Send error to analytics
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            // TODO: Send error to analytics
        });
        
        // Editor-specific GAS functions with direct calls
        function getCurrentUser() {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .getCurrentUser();
            });
        }
        
        function getProjectData(projectId) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .getProjectData(projectId);
            });
        }
        
        function saveProjectData(projectData) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .saveProjectData(projectData);
            });
        }
        
        function uploadMedia(fileData, fileName, projectId) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .uploadMedia(fileData, fileName, projectId);
            });
        }
        
        function getProjectMediaUrl(projectId, fileName) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .getProjectMediaUrl(projectId, fileName);
            });
        }
        
        // Initialize editor application
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Get project ID from URL parameters or GAS context
                const projectId = '{{PROJECT_ID}}';
                
                if (!projectId) {
                    throw new Error('No project ID provided');
                }
                
                // Initialize services
                const projectManager = new ProjectManager();
                await projectManager.initialize({
                    sheetsAPI: new GoogleSheetsAPI(),
                    hotspotManager: new HotspotManager(),
                    mediaHandler: new MediaHandler(),
                    eventTypeHandlers: new EventTypeHandlers()
                });
                
                // Initialize components
                const header = new AppHeader(document.getElementById('app-header'));
                const sidebar = new Sidebar(document.getElementById('sidebar'));
                const canvas = new MainCanvas(document.getElementById('canvas-container'));
                const configPanel = new ConfigPanel(document.getElementById('config-panel'));
                const sequencer = new WalkthroughSequencer(document.getElementById('sequencer-container'));
                
                // Set component references
                projectManager.setComponents({
                    header,
                    sidebar,
                    canvas,
                    configPanel,
                    sequencer
                });
                
                // Store global references
                window.ExplicoApp.projectManager = projectManager;
                window.ExplicoApp.components = {
                    header,
                    sidebar,
                    canvas,
                    configPanel,
                    sequencer
                };
                
                // Load project data
                await projectManager.openProject(projectId);
                
                // Setup header event listeners
                document.getElementById('save-btn').addEventListener('click', async () => {
                    try {
                        await projectManager.saveCurrentProject();
                        // Show success feedback
                        const btn = document.getElementById('save-btn');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<span class="material-symbols-outlined text-sm">check</span> Saved';
                        btn.classList.add('bg-green-600');
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.classList.remove('bg-green-600');
                        }, 2000);
                    } catch (error) {
                        console.error('Save error:', error);
                        alert('Error saving project: ' + error.message);
                    }
                });
                
                document.getElementById('preview-btn').addEventListener('click', () => {
                    // TODO: Implement preview functionality
                    alert('Preview functionality coming soon!');
                });
                
                document.getElementById('back-to-dashboard-btn').addEventListener('click', () => {
                    // Navigate back to dashboard
                    window.location.href = 'project-dashboard.html';
                });
                
                window.ExplicoApp.initialized = true;
                console.log('Editor application initialized successfully');
                
            } catch (error) {
                console.error('Failed to initialize editor:', error);
                alert('Failed to initialize editor: ' + error.message);
            }
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function(event) {
            // Auto-save on exit if there are unsaved changes
            if (window.ExplicoApp.projectManager && window.ExplicoApp.projectManager.hasUnsavedChanges) {
                event.preventDefault();
                event.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                return event.returnValue;
            }
        });
    </script>
</body>
</html>