name: Auto Deploy Apps Script
on:
  push:
    branches:
      - main # Change this to your main branch if it's not named 'main'
      # Add other branches here if you want pushes to them to trigger deployment
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*' # Or a specific version like '18.x' or '20.x'
    - name: Install clasp
      run: npm install -g @google/clasp
    - name: Authenticate clasp
      run: |
        # Create the credentials file from the secret
        echo '${{ secrets.CLASPRC_JSON }}' > ~/.clasprc.json
        # Validate JSON format (fails if not valid)
        jq empty ~/.clasprc.json || { echo "Invalid JSON in credentials"; cat ~/.clasprc.json; exit 1; }
    - name: Build project files
      run: |
        # Make build script executable and run it
        chmod +x ./build.sh
        echo "ğŸ”§ Building project files..."
        ./build.sh
        echo "âœ… Build completed successfully"
        # List built files for verification
        echo "ğŸ“ Files in dist directory:"
        ls -la dist/
    - name: Push code to Apps Script
      # Use --force if you encounter issues with minor version bumps
      run: |
        echo "ğŸš€ Pushing code to Google Apps Script..."
        clasp push --force
        echo "âœ… Code pushed successfully"
    - name: Update deployment
      # If you have a specific deployment ID to update, use this format
      run: |
        echo "ğŸš¢ Updating deployment..."
        if [ -n "${{ secrets.DEPLOYMENT_ID }}" ]; then
          echo "ğŸ“„ Using existing deployment ID: ${{ secrets.DEPLOYMENT_ID }}"
          clasp deploy --deploymentId ${{ secrets.DEPLOYMENT_ID }} --description "Auto-deployment $(date)"
        else
          echo "ğŸ“„ Creating new deployment"
          clasp deploy --description "Auto-deployment $(date)"
        fi
        echo "âœ… Deployment updated successfully"
    # Optional: Clean up the credentials file (good practice)
    - name: Clean up credentials
      if: always() # Run even if previous steps failed
      run: rm -f ~/.clasprc.json