<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotspot Editor - Explico Learning</title>
    
    <!-- Preconnect to external services -->
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    
    <!-- Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Spline+Sans:wght@400;500;700" onload="this.rel='stylesheet'">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <!-- Base Styles -->
    <style type="text/css">
        /* Ensure CSS variables are loaded first with fallbacks */
        :root {
            /* Fallback CSS variables in case styles.html doesn't load */
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --brand-primary: #2d3f89;
            --brand-primary-hover: #3c52b2;
            --text-primary: #ffffff;
            --text-secondary: #d1d5db;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --space-2: 0.5rem;
            --space-4: 1rem;
            --radius-md: 0.375rem;
            --transition-normal: 200ms ease;
        }
        
        <?!= include('styles'); ?>
        /* Additional styles for hotspot editor */

        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all var(--transition-normal);
            border: 1px solid transparent;
        }

        .btn-primary {
            background: var(--brand-primary);
            color: var(--text-primary);
        }

        .btn-primary:hover {
            background: var(--brand-primary-hover);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-color: var(--gray-600);
        }

        .btn-secondary:hover {
            background: var(--gray-600);
            color: var(--text-primary);
        }

        .btn-outline {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-color: var(--gray-600);
        }

        .btn-outline:hover {
            background: var(--gray-600);
            color: var(--text-primary);
        }

        .hotspot {
            position: absolute;
            width: 32px;
            height: 32px;
            background: rgba(59, 130, 246, 0.8);
            border: 2px solid #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: all 0.2s ease;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hotspot:hover {
            background: rgba(59, 130, 246, 1);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .hotspot.selected {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.8);
        }

        .hotspot.dragging {
            z-index: 1000;
            transform: translate(-50%, -50%) scale(1.2);
        }

        .canvas-container {
            position: relative;
            overflow: hidden;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .canvas-background {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .creation-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.1);
            cursor: crosshair;
            z-index: 5;
        }

        .sidebar {
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .config-panel {
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .slide-thumbnail {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .slide-thumbnail.active {
            border-color: #3b82f6;
        }

        .hotspot-sequence-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .hotspot-sequence-item:hover {
            background: #f3f4f6;
        }

        .hotspot-sequence-item.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-draft {
            background: #fef3c7;
            color: #d97706;
        }

        .status-published {
            background: #d1fae5;
            color: #047857;
        }
    </style>
</head>
<body class="font-primary" style="background-color: var(--bg-primary);">
    <!-- Application Container -->
    <div id="app" class="app-container flex flex-col min-h-screen">
        <!-- Header -->
        <header id="app-header" class="flex-shrink-0 bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <h1 id="project-title" class="text-2xl font-bold text-gray-900">Loading Project...</h1>
                        <div class="ml-4 flex items-center space-x-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                Editor
                            </span>
                            <span id="project-status" class="status-badge status-draft">Draft</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="save-btn" class="btn btn-primary">
                            <span class="material-symbols-outlined text-sm">save</span>
                            Save Project
                        </button>
                        <button id="preview-btn" class="btn btn-secondary">
                            <span class="material-symbols-outlined text-sm">play_arrow</span>
                            Preview
                        </button>
                        <button id="back-to-dashboard-btn" class="btn btn-outline">
                            <span class="material-symbols-outlined text-sm">arrow_back</span>
                            Back to Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-80 bg-white border-r border-gray-200 flex-shrink-0 sidebar">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">Slides</h3>
                        <button id="add-slide-btn" class="btn btn-primary text-sm py-1 px-2">
                            <span class="material-symbols-outlined text-xs">add</span>
                            Add Slide
                        </button>
                    </div>
                </div>
                <div id="slides-list" class="p-4 space-y-3">
                    <!-- Slides will be dynamically populated -->
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 flex overflow-hidden">
                <!-- Canvas Area -->
                <div class="flex-1 p-4">
                    <div class="h-full flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <h3 id="current-slide-title" class="text-lg font-semibold text-gray-900">Select a slide to begin editing</h3>
                            <div class="flex items-center space-x-2">
                                <button id="toggle-creation-mode" class="btn btn-outline text-sm">
                                    <span class="material-symbols-outlined text-xs">add_circle</span>
                                    Creation Mode
                                </button>
                                <select id="zoom-level" class="border border-gray-300 rounded px-2 py-1 text-sm">
                                    <option value="0.5">50%</option>
                                    <option value="0.75">75%</option>
                                    <option value="1" selected>100%</option>
                                    <option value="1.25">125%</option>
                                    <option value="1.5">150%</option>
                                </select>
                            </div>
                        </div>
                        <div id="canvas-container" class="flex-1 canvas-container">
                            <div id="canvas-empty-state" class="h-full flex items-center justify-center text-gray-500">
                                <div class="text-center">
                                    <span class="material-symbols-outlined text-6xl text-gray-300 mb-4">image</span>
                                    <p class="text-lg">Select a slide or add a new one to start editing</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Config Panel -->
                <aside id="config-panel" class="w-96 bg-white border-l border-gray-200 flex-shrink-0 config-panel hidden">
                    <div class="p-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Hotspot Configuration</h3>
                            <button id="close-config-panel" class="text-gray-400 hover:text-gray-600">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>
                    </div>
                    <div id="config-form" class="p-4">
                        <!-- Configuration form will be dynamically populated -->
                    </div>
                </aside>
            </main>
        </div>

        <!-- Bottom Timeline/Sequencer -->
        <div id="sequencer-container" class="h-32 bg-white border-t border-gray-200 flex-shrink-0">
            <div class="p-4 h-full">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-semibold text-gray-900">Hotspot Sequence</h3>
                    <div class="text-xs text-gray-500" id="sequence-info">
                        No hotspots on current slide
                    </div>
                </div>
                <div id="hotspots-sequence" class="flex space-x-2 overflow-x-auto h-20">
                    <!-- Hotspot sequence items will be dynamically populated -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Slide Modal -->
    <div id="add-slide-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Add New Slide</h3>
            </div>
            <div class="px-6 py-4">
                <div class="space-y-4">
                    <div>
                        <label class="form-label">Slide Name</label>
                        <input type="text" id="new-slide-name" class="form-input" placeholder="Enter slide name...">
                    </div>
                    <div>
                        <label class="form-label">Background Media</label>
                        <div class="mt-2 border-2 border-dashed border-gray-300 rounded-lg p-4">
                            <div class="text-center">
                                <span class="material-symbols-outlined text-gray-400 text-3xl mb-2">upload</span>
                                <p class="text-sm text-gray-600">Drag and drop an image or video, or paste a YouTube URL</p>
                                <input type="file" id="slide-media-upload" class="hidden" accept="image/*,video/*">
                                <input type="url" id="slide-media-url" class="form-input mt-2" placeholder="Or enter YouTube/media URL...">
                                <button type="button" onclick="document.getElementById('slide-media-upload').click()" class="btn btn-outline mt-2 text-sm">
                                    Choose File
                                </button>
                            </div>
                        </div>
                        <div id="media-preview" class="mt-2 hidden">
                            <img id="media-preview-img" class="w-full h-32 object-cover rounded border" style="display: none;">
                            <video id="media-preview-video" class="w-full h-32 object-cover rounded border" style="display: none;" controls></video>
                        </div>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                <button id="cancel-add-slide" class="btn btn-outline">Cancel</button>
                <button id="create-slide" class="btn btn-primary">Create Slide</button>
            </div>
        </div>
    </div>

    <!-- Core Constants -->
    <script>
        // Initialize constants with error handling
        let CONSTANTS;
        try {
            CONSTANTS = <?!= CONSTANTS ?>;
            console.log('‚úÖ Constants loaded successfully:', Object.keys(CONSTANTS || {}).length, 'categories');
        } catch (error) {
            console.error('‚ùå Failed to load constants:', error);
            CONSTANTS = {
                EVENT_TYPES: { TEXT_POPUP: 'text_popup', TEXT_ON_IMAGE: 'text_on_image' },
                TRIGGER_TYPES: { CLICK: 'click', HOVER: 'hover' },
                PROJECT_STATUS: { DRAFT: 'draft', PUBLISHED: 'published' }
            };
            console.log('üìÑ Using fallback constants');
        }
        
        // Validate essential constants
        if (!CONSTANTS || typeof CONSTANTS !== 'object') {
            console.error('‚ùå Constants validation failed, using minimal fallback');
            CONSTANTS = { EVENT_TYPES: {}, TRIGGER_TYPES: {}, PROJECT_STATUS: {} };
        }
    </script>
    
    <!-- Utility Components -->
    <!--
    <?!= include('FormControls'); ?>
    <script>console.log('FormControls loaded');</script>
    <?!= include('StatusBadge'); ?>
    <script>console.log('StatusBadge loaded');</script>
    <?!= include('ProgressBar'); ?>
    <script>console.log('ProgressBar loaded');</script>
    <?!= include('HotspotRenderer'); ?>
    <script>console.log('HotspotRenderer loaded');</script>
    -->
    
    <!-- Layout Components -->
    <!--
    <?!= include('AppHeader'); ?>
    <script>console.log('AppHeader loaded');</script>
    <?!= include('Sidebar'); ?>
    <script>console.log('Sidebar loaded');</script>
    <?!= include('MainCanvas'); ?>
    <script>console.log('MainCanvas loaded');</script>
    <?!= include('ConfigPanel'); ?>
    <script>console.log('ConfigPanel loaded');</script>
    <?!= include('WalkthroughSequencer'); ?>
    <script>console.log('WalkthroughSequencer loaded');</script>
    -->
    
    <!-- Business Logic Services -->
    <!--
    <?!= include('GoogleSheetsAPI'); ?>
    <script>console.log('GoogleSheetsAPI loaded');</script>
    <?!= include('MediaHandler'); ?>
    <script>console.log('MediaHandler loaded');</script>
    <?!= include('EventTypeHandlers'); ?>
    <script>console.log('EventTypeHandlers loaded');</script>
    <?!= include('HotspotManager'); ?>
    <script>console.log('HotspotManager loaded');</script>
    <?!= include('ProjectManager'); ?>
    <script>console.log('ProjectManager loaded');</script>
    -->
    
    <!-- Application Initialization -->
    <script>
        // Basic application initialization
        window.ExplicoApp = {
            initialized: false,
            currentProject: null,
            currentSlide: null,
            selectedHotspot: null,
            creationMode: false,
            hotspots: {},
            slides: {}
        };

        // Get project ID from URL parameters or template
        function getProjectId() {
            let projectId;
            try {
                // In GAS, project ID will be passed via template
                projectId = '<?!= typeof PROJECT_ID !== "undefined" ? PROJECT_ID : "" ?>';
                
                // Validate project ID
                if (!projectId || projectId === '' || projectId === 'undefined') {
                    console.warn('‚ö†Ô∏è No PROJECT_ID provided via template, checking URL parameters');
                    
                    // Fallback: try to get from URL parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    projectId = urlParams.get('project');
                    
                    if (!projectId) {
                        console.error('‚ùå No project ID found in template or URL');
                        return null;
                    }
                }
                
                console.log('‚úÖ Project ID loaded:', projectId);
                return projectId;
                
            } catch (error) {
                console.error('‚ùå Error getting project ID:', error);
                
                // Final fallback: try URL parameters
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const fallbackId = urlParams.get('project');
                    if (fallbackId) {
                        console.log('üìÑ Using fallback project ID from URL:', fallbackId);
                        return fallbackId;
                    }
                } catch (urlError) {
                    console.error('‚ùå URL parameter fallback also failed:', urlError);
                }
                
                return null;
            }
        }

        // Initialize the editor application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing Hotspot Editor...');
            
            try {
                var projectId = getProjectId();
                
                if (!projectId) {
                    showError('No project ID provided. Please navigate to this page from the project dashboard.', {
                        persistent: true,
                        actionText: 'Go to Dashboard', 
                        actionCallback: () => window.location.href = '?page=dashboard'
                    });
                    return;
                }
                
                console.log('üîç Loading project:', projectId);
                
                // Show initial loading state
                const loadingIndicator = showLoading('Initializing editor...');
                
                // Load actual project data from Google Sheets
                loadProjectData(projectId, function(error) {
                    hideLoading();
                    
                    if (error) {
                        console.error('‚ùå Failed to initialize editor:', error);
                        
                        // Show specific error with action buttons
                        if (error.message.includes('not found')) {
                            showError(error.message, {
                                persistent: true,
                                actionText: 'Go to Dashboard',
                                actionCallback: () => window.location.href = '?page=dashboard'
                            });
                        } else if (error.message.includes('timed out')) {
                            showError(error.message, {
                                actionText: 'Retry',
                                actionCallback: () => location.reload()
                            });
                        } else if (error.message.includes('Authorization')) {
                            showError(error.message, {
                                actionText: 'Sign In',
                                actionCallback: () => location.reload()
                            });
                        } else {
                            showError(error.message, {
                                actionText: 'Retry',
                                actionCallback: () => location.reload()
                            });
                        }
                        return;
                    }
                    
                    try {
                        // Setup event listeners
                        setupEventListeners();
                        
                        window.ExplicoApp.initialized = true;
                        console.log('‚úÖ Editor initialized successfully');
                        showSuccess('Editor loaded successfully!');
                        
                        // Log app state for debugging
                        console.log('üîß App State:', {
                            project: window.ExplicoApp.currentProject?.name,
                            slides: Object.keys(window.ExplicoApp.slides).length,
                            initialized: window.ExplicoApp.initialized
                        });
                        
                    } catch (setupError) {
                        console.error('‚ùå Error during editor setup:', setupError);
                        showError('Editor setup failed: ' + setupError.message, {
                            actionText: 'Reload',
                            actionCallback: () => location.reload()
                        });
                    }
                });
                
            } catch (error) {
                hideLoading();
                console.error('‚ùå Critical initialization error:', error);
                showError('Critical error during initialization: ' + error.message, {
                    persistent: true,
                    actionText: 'Reload Page',
                    actionCallback: () => location.reload()
                });
            }
        });

        // Load project from Google Sheets via GAS
        function loadProjectData(projectId, callback) {
            if (!projectId) {
                const error = new Error('No project ID provided');
                console.error('‚ùå Load project data failed:', error);
                callback(error);
                return;
            }
            
            console.log('üîÑ Loading project data for:', projectId);
            
            // Add loading indicator
            const projectTitle = document.getElementById('project-title');
            if (projectTitle) {
                projectTitle.textContent = 'Loading project...';
                projectTitle.classList.add('animate-pulse');
            }
            
            // Set up timeout for the request
            let hasCompleted = false;
            const timeoutId = setTimeout(function() {
                if (!hasCompleted) {
                    hasCompleted = true;
                    console.error('‚è∞ Project data loading timed out after 15 seconds');
                    const timeoutError = new Error('Project loading timed out. Please check your connection and try again.');
                    callback(timeoutError);
                }
            }, 15000); // 15 second timeout
            
            try {
                // Validate google.script.run is available
                if (typeof google === 'undefined' || !google.script || !google.script.run) {
                    clearTimeout(timeoutId);
                    const gasError = new Error('Google Apps Script runtime not available. Please refresh the page.');
                    console.error('‚ùå Google Apps Script not available:', gasError);
                    callback(gasError);
                    return;
                }
                
                // Use Google Apps Script function to get project data
                google.script.run
                    .withSuccessHandler(function(projectData) {
                        if (hasCompleted) return; // Timeout already occurred
                        hasCompleted = true;
                        clearTimeout(timeoutId);
                        
                        try {
                            console.log('üì¶ Received project data:', projectData);
                            
                            if (!projectData) {
                                const notFoundError = new Error(`Project "${projectId}" not found. It may have been deleted or you may not have access.`);
                                console.error('‚ùå Project not found:', notFoundError);
                                callback(notFoundError);
                                return;
                            }
                            
                            // Validate project data structure
                            if (typeof projectData !== 'object') {
                                const structureError = new Error('Invalid project data received from server');
                                console.error('‚ùå Invalid project data structure:', projectData);
                                callback(structureError);
                                return;
                            }
                            
                            // Store project data
                            window.ExplicoApp.currentProject = projectData;
                            
                            // Update UI with project information
                            if (projectTitle) {
                                projectTitle.textContent = projectData.name || 'Untitled Project';
                                projectTitle.classList.remove('animate-pulse');
                            }
                            
                            // Load slides with error handling
                            try {
                                if (projectData.slides && Array.isArray(projectData.slides) && projectData.slides.length > 0) {
                                    console.log('üìÑ Loading', projectData.slides.length, 'slides');
                                    for (var i = 0; i < projectData.slides.length; i++) {
                                        var slide = projectData.slides[i];
                                        if (slide && slide.id) {
                                            window.ExplicoApp.slides[slide.id] = slide;
                                        }
                                    }
                                    renderSlidesList();
                                    console.log('‚úÖ Slides loaded successfully');
                                } else {
                                    console.log('üìù No slides found, showing empty state');
                                    showEmptySlideState();
                                }
                            } catch (slideError) {
                                console.error('‚ö†Ô∏è Error processing slides:', slideError);
                                showEmptySlideState(); // Fallback to empty state
                            }
                            
                            console.log('‚úÖ Project data loaded successfully');
                            callback(null); // Success
                            
                        } catch (processingError) {
                            console.error('‚ùå Error processing project data:', processingError);
                            callback(processingError);
                        }
                    })
                    .withFailureHandler(function(error) {
                        if (hasCompleted) return; // Timeout already occurred
                        hasCompleted = true;
                        clearTimeout(timeoutId);
                        
                        console.error('‚ùå Google Apps Script call failed:', error);
                        
                        // Enhanced error message based on error type
                        let userFriendlyError;
                        if (error && error.message) {
                            if (error.message.includes('Authorization')) {
                                userFriendlyError = new Error('Authorization required. Please refresh the page and sign in again.');
                            } else if (error.message.includes('not found')) {
                                userFriendlyError = new Error(`Project "${projectId}" was not found. It may have been deleted.`);
                            } else {
                                userFriendlyError = new Error(`Server error: ${error.message}. Please try again.`);
                            }
                        } else {
                            userFriendlyError = new Error('Failed to load project data. Please check your connection and try again.');
                        }
                        
                        callback(userFriendlyError);
                    })
                    .getProjectData(projectId);
                    
                console.log('üì§ Project data request sent to Google Apps Script');
                
            } catch (error) {
                if (hasCompleted) return;
                hasCompleted = true;
                clearTimeout(timeoutId);
                
                console.error('‚ùå Error setting up project data request:', error);
                callback(new Error('Failed to request project data: ' + error.message));
            }
        }
        
        // Show empty state for no slides
        function showEmptySlideState() {
            var slidesList = document.getElementById('slides-list');
            slidesList.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <span class="material-symbols-outlined text-4xl mb-2">slideshow</span>
                    <p>No slides yet</p>
                    <button onclick="showAddSlideModal()" class="btn btn-primary mt-2 text-sm">
                        Add First Slide
                    </button>
                </div>
            `;
        }

        // Render slides in sidebar
        function renderSlidesList() {
            var slidesList = document.getElementById('slides-list');
            var slidesArray = [];
            for (var key in window.ExplicoApp.slides) {
                if (window.ExplicoApp.slides.hasOwnProperty(key)) {
                    slidesArray.push(window.ExplicoApp.slides[key]);
                }
            }
            var slides = slidesArray.sort(function(a, b) { return a.order - b.order; });

            slidesList.innerHTML = slides.map(function(slide) { return `
                <div class="slide-item p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 ${slide.id === window.ExplicoApp.currentSlide?.id ? 'bg-blue-50 border-blue-200' : ''}" 
                     data-slide-id="${slide.id}" onclick="selectSlide('${slide.id}')">
                    <div class="flex items-center space-x-3">
                        <img src="${slide.backgroundUrl}" alt="${slide.name}" class="slide-thumbnail">
                        <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-medium text-gray-900 truncate">${slide.name}</h4>
                            <p class="text-xs text-gray-500">${slide.backgroundType.toUpperCase()}</p>
                        </div>
                        <div class="flex items-center space-x-1">
                            <button class="text-gray-400 hover:text-gray-600 p-1" onclick="event.stopPropagation(); editSlide('${slide.id}')">
                                <span class="material-symbols-outlined text-sm">edit</span>
                            </button>
                            <button class="text-gray-400 hover:text-red-600 p-1" onclick="event.stopPropagation(); deleteSlide('${slide.id}')">
                                <span class="material-symbols-outlined text-sm">delete</span>
                            </button>
                        </div>
                    </div>
                </div>
            `; }).join('');
        }

        // Select a slide for editing
        function selectSlide(slideId) {
            const slide = window.ExplicoApp.slides[slideId];
            if (!slide) return;

            window.ExplicoApp.currentSlide = slide;
            document.getElementById('current-slide-title').textContent = slide.name;

            // Update canvas with slide background
            const canvasContainer = document.getElementById('canvas-container');
            const emptyState = document.getElementById('canvas-empty-state');
            
            emptyState.style.display = 'none';
            
            canvasContainer.innerHTML = `
                <img src="${slide.backgroundUrl}" alt="${slide.name}" class="canvas-background" id="canvas-background">
                <div id="hotspots-layer" class="absolute inset-0"></div>
                <div id="creation-overlay" class="creation-overlay" style="display: none;"></div>
            `;

            // Load hotspots for this slide
            loadSlideHotspots(slideId);
            
            // Update slides list highlighting
            renderSlidesList();

            console.log('Selected slide:', slide.name);
        }

        // Load hotspots for a slide
        function loadSlideHotspots(slideId) {
            const hotspotsLayer = document.getElementById('hotspots-layer');
            if (!hotspotsLayer) return;

            // Clear existing hotspots
            hotspotsLayer.innerHTML = '';

            // For demo purposes, add some sample hotspots
            if (slideId === 'slide-1') {
                const sampleHotspots = [
                    { id: 'hotspot-1', x: 200, y: 150, eventType: 'text_popup', title: 'Welcome!', content: 'This is a sample text popup hotspot.' },
                    { id: 'hotspot-2', x: 400, y: 300, eventType: 'text_on_image', title: 'Feature A', content: 'This shows a tooltip overlay.' }
                ];

                sampleHotspots.forEach(hotspot => {
                    createHotspotElement(hotspot);
                });

                updateSequencer();
            }
        }

        // Create hotspot visual element
        function createHotspotElement(hotspot) {
            const hotspotsLayer = document.getElementById('hotspots-layer');
            if (!hotspotsLayer) return;

            const hotspotEl = document.createElement('div');
            hotspotEl.className = 'hotspot';
            hotspotEl.dataset.hotspotId = hotspot.id;
            hotspotEl.style.left = hotspot.x + 'px';
            hotspotEl.style.top = hotspot.y + 'px';
            hotspotEl.innerHTML = '<span class="material-symbols-outlined text-white text-xs">radio_button_checked</span>';

            hotspotEl.addEventListener('click', (e) => {
                e.stopPropagation();
                selectHotspot(hotspot.id);
            });

            hotspotsLayer.appendChild(hotspotEl);
            window.ExplicoApp.hotspots[hotspot.id] = hotspot;
        }

        // Select a hotspot
        function selectHotspot(hotspotId) {
            // Clear previous selection
            document.querySelectorAll('.hotspot.selected').forEach(el => {
                el.classList.remove('selected');
            });

            // Select new hotspot
            const hotspotEl = document.querySelector(`[data-hotspot-id="${hotspotId}"]`);
            if (hotspotEl) {
                hotspotEl.classList.add('selected');
            }

            const hotspot = window.ExplicoApp.hotspots[hotspotId];
            if (hotspot) {
                window.ExplicoApp.selectedHotspot = hotspot;
                showConfigPanel(hotspot);
                console.log('Selected hotspot:', hotspot.title);
            }
        }

        // Show configuration panel
        function showConfigPanel(hotspot) {
            const configPanel = document.getElementById('config-panel');
            const configForm = document.getElementById('config-form');

            configForm.innerHTML = `
                <div class="space-y-4">
                    <div class="form-group">
                        <label class="form-label">Hotspot Title</label>
                        <input type="text" class="form-input" value="${hotspot.title}" onchange="updateHotspotProperty('title', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Event Type</label>
                        <select class="form-input" onchange="updateHotspotProperty('eventType', this.value)">
                            <option value="text_popup" ${hotspot.eventType === 'text_popup' ? 'selected' : ''}>Text Popup</option>
                            <option value="text_on_image" ${hotspot.eventType === 'text_on_image' ? 'selected' : ''}>Text on Image</option>
                            <option value="pan_zoom" ${hotspot.eventType === 'pan_zoom' ? 'selected' : ''}>Pan/Zoom</option>
                            <option value="spotlight" ${hotspot.eventType === 'spotlight' ? 'selected' : ''}>Spotlight</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Content</label>
                        <textarea class="form-input" rows="3" onchange="updateHotspotProperty('content', this.value)">${hotspot.content || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Position</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" class="form-input" placeholder="X" value="${hotspot.x}" onchange="updateHotspotProperty('x', parseInt(this.value))">
                            <input type="number" class="form-input" placeholder="Y" value="${hotspot.y}" onchange="updateHotspotProperty('y', parseInt(this.value))">
                        </div>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary w-full" onclick="previewHotspot()">
                            <span class="material-symbols-outlined text-sm">play_arrow</span>
                            Preview Effect
                        </button>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-outline w-full text-red-600 border-red-300 hover:bg-red-50" onclick="deleteHotspot()">
                            <span class="material-symbols-outlined text-sm">delete</span>
                            Delete Hotspot
                        </button>
                    </div>
                </div>
            `;

            configPanel.classList.remove('hidden');
        }

        // Update hotspot property
        function updateHotspotProperty(property, value) {
            if (!window.ExplicoApp.selectedHotspot) return;

            window.ExplicoApp.selectedHotspot[property] = value;
            
            // Update visual position if x or y changed
            if (property === 'x' || property === 'y') {
                const hotspotEl = document.querySelector(`[data-hotspot-id="${window.ExplicoApp.selectedHotspot.id}"]`);
                if (hotspotEl) {
                    hotspotEl.style.left = window.ExplicoApp.selectedHotspot.x + 'px';
                    hotspotEl.style.top = window.ExplicoApp.selectedHotspot.y + 'px';
                }
            }

            console.log('Updated hotspot property:', property, '=', value);
        }

        // Update sequencer display
        function updateSequencer() {
            const sequenceContainer = document.getElementById('hotspots-sequence');
            const sequenceInfo = document.getElementById('sequence-info');
            
            const slideHotspots = Object.values(window.ExplicoApp.hotspots);
            
            if (slideHotspots.length === 0) {
                sequenceInfo.textContent = 'No hotspots on current slide';
                sequenceContainer.innerHTML = '<div class="text-gray-500 text-sm">Click on the canvas to add hotspots</div>';
                return;
            }

            sequenceInfo.textContent = `${slideHotspots.length} hotspot${slideHotspots.length !== 1 ? 's' : ''}`;

            sequenceContainer.innerHTML = slideHotspots.map((hotspot, index) => `
                <div class="hotspot-sequence-item ${hotspot.id === window.ExplicoApp.selectedHotspot?.id ? 'active' : ''}" 
                     onclick="selectHotspot('${hotspot.id}')" style="min-width: 120px;">
                    <div class="flex items-center space-x-2">
                        <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold">
                            ${index + 1}
                        </span>
                        <div class="flex-1 min-w-0">
                            <div class="text-xs font-medium truncate">${hotspot.title}</div>
                            <div class="text-xs text-gray-500">${hotspot.eventType.replace('_', ' ')}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Header buttons
            document.getElementById('save-btn').addEventListener('click', saveProject);
            document.getElementById('preview-btn').addEventListener('click', previewProject);
            document.getElementById('back-to-dashboard-btn').addEventListener('click', () => {
                window.location.href = '?page=dashboard';
            });

            // Sidebar
            document.getElementById('add-slide-btn').addEventListener('click', showAddSlideModal);

            // Canvas creation mode
            document.getElementById('toggle-creation-mode').addEventListener('click', toggleCreationMode);

            // Config panel
            document.getElementById('close-config-panel').addEventListener('click', () => {
                document.getElementById('config-panel').classList.add('hidden');
                window.ExplicoApp.selectedHotspot = null;
                document.querySelectorAll('.hotspot.selected').forEach(el => {
                    el.classList.remove('selected');
                });
            });

            // Add slide modal
            document.getElementById('cancel-add-slide').addEventListener('click', hideAddSlideModal);
            document.getElementById('create-slide').addEventListener('click', createNewSlide);
        }

        // Toggle creation mode
        function toggleCreationMode() {
            window.ExplicoApp.creationMode = !window.ExplicoApp.creationMode;
            const overlay = document.getElementById('creation-overlay');
            const btn = document.getElementById('toggle-creation-mode');

            if (window.ExplicoApp.creationMode) {
                if (overlay) overlay.style.display = 'block';
                btn.textContent = 'Exit Creation Mode';
                btn.classList.add('bg-orange-100', 'text-orange-800');
                
                // Add click listener for creating hotspots
                if (overlay) {
                    overlay.addEventListener('click', handleCanvasClick);
                }
            } else {
                if (overlay) overlay.style.display = 'none';
                btn.innerHTML = '<span class="material-symbols-outlined text-xs">add_circle</span> Creation Mode';
                btn.classList.remove('bg-orange-100', 'text-orange-800');
            }
        }

        // Handle canvas click to create hotspots
        function handleCanvasClick(e) {
            if (!window.ExplicoApp.creationMode) return;

            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const newHotspot = {
                id: 'hotspot-' + Date.now(),
                x: x,
                y: y,
                eventType: 'text_popup',
                title: 'New Hotspot',
                content: 'Click to configure this hotspot'
            };

            createHotspotElement(newHotspot);
            updateSequencer();
            selectHotspot(newHotspot.id);

            console.log('Created new hotspot at', x, y);
        }

        // Show add slide modal
        function showAddSlideModal() {
            document.getElementById('add-slide-modal').classList.remove('hidden');
            document.getElementById('add-slide-modal').classList.add('flex');
            document.getElementById('new-slide-name').focus();
        }

        // Hide add slide modal
        function hideAddSlideModal() {
            document.getElementById('add-slide-modal').classList.add('hidden');
            document.getElementById('add-slide-modal').classList.remove('flex');
            document.getElementById('new-slide-name').value = '';
            document.getElementById('slide-media-url').value = '';
        }

        // Create new slide
        function createNewSlide() {
            const name = document.getElementById('new-slide-name').value.trim();
            const mediaUrl = document.getElementById('slide-media-url').value.trim() || 'https://placehold.co/800x600/6B7280/FFFFFF?text=New+Slide';

            if (!name) {
                alert('Please enter a slide name');
                return;
            }

            const newSlide = {
                id: 'slide-' + Date.now(),
                name: name,
                backgroundUrl: mediaUrl,
                backgroundType: 'image',
                order: Object.keys(window.ExplicoApp.slides).length
            };

            window.ExplicoApp.slides[newSlide.id] = newSlide;
            renderSlidesList();
            hideAddSlideModal();
            selectSlide(newSlide.id);

            console.log('Created new slide:', name);
        }

        // Save project
        function saveProject() {
            console.log('Saving project...');
            const btn = document.getElementById('save-btn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<span class="material-symbols-outlined text-sm animate-spin">refresh</span> Saving...';
            btn.disabled = true;

            // Simulate save delay
            setTimeout(() => {
                btn.innerHTML = '<span class="material-symbols-outlined text-sm">check</span> Saved!';
                btn.classList.add('bg-green-600');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-green-600');
                    btn.disabled = false;
                }, 2000);
            }, 1000);
        }

        // Preview project
        function previewProject() {
            alert('Preview functionality will open a new window with the walkthrough player');
        }

        // Preview hotspot effect
        function previewHotspot() {
            if (!window.ExplicoApp.selectedHotspot) return;
            
            const hotspot = window.ExplicoApp.selectedHotspot;
            alert(`Preview: ${hotspot.eventType}\nTitle: ${hotspot.title}\nContent: ${hotspot.content}`);
        }

        // Delete hotspot
        function deleteHotspot() {
            if (!window.ExplicoApp.selectedHotspot) return;

            if (confirm('Are you sure you want to delete this hotspot?')) {
                const hotspotId = window.ExplicoApp.selectedHotspot.id;
                const hotspotEl = document.querySelector(`[data-hotspot-id="${hotspotId}"]`);
                
                if (hotspotEl) {
                    hotspotEl.remove();
                }
                
                delete window.ExplicoApp.hotspots[hotspotId];
                window.ExplicoApp.selectedHotspot = null;
                
                document.getElementById('config-panel').classList.add('hidden');
                updateSequencer();
                
                console.log('Deleted hotspot:', hotspotId);
            }
        }

        // Show error message with improved UX
        function showError(message, options = {}) {
            console.error('üö® User Error:', message);
            
            // Remove existing error messages
            const existingErrors = document.querySelectorAll('.error-notification');
            existingErrors.forEach(error => error.remove());
            
            const {
                duration = 8000,
                actionText = null,
                actionCallback = null,
                persistent = false
            } = options;
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-notification fixed top-4 right-4 max-w-md bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg shadow-lg z-50';
            
            let actionButton = '';
            if (actionText && actionCallback) {
                actionButton = `
                    <button onclick="(${actionCallback.toString()})()" class="ml-2 px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors">
                        ${actionText}
                    </button>
                `;
            }
            
            errorDiv.innerHTML = `
                <div class="flex items-start">
                    <span class="material-symbols-outlined text-red-600 text-lg mr-3 flex-shrink-0 mt-0.5">error</span>
                    <div class="flex-1">
                        <div class="text-sm font-medium mb-1">Something went wrong</div>
                        <div class="text-sm">${message}</div>
                        <div class="mt-2 flex items-center">
                            <button onclick="location.reload()" class="text-sm text-red-600 hover:text-red-800 underline">
                                Refresh Page
                            </button>
                            ${actionButton}
                        </div>
                    </div>
                    ${!persistent ? `<button onclick="this.closest('.error-notification').remove()" class="ml-2 text-red-400 hover:text-red-600 flex-shrink-0">
                        <span class="material-symbols-outlined text-sm">close</span>
                    </button>` : ''}
                </div>
            `;
            
            document.body.appendChild(errorDiv);
            
            // Add slide-in animation
            requestAnimationFrame(() => {
                errorDiv.style.transform = 'translateX(0)';
            });
            
            // Auto-remove if not persistent
            if (!persistent) {
                setTimeout(() => {
                    if (errorDiv.parentElement) {
                        errorDiv.style.transform = 'translateX(100%)';
                        setTimeout(() => errorDiv.remove(), 300);
                    }
                }, duration);
            }
        }
        
        // Show success message
        function showSuccess(message, duration = 4000) {
            console.log('‚úÖ Success:', message);
            
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 max-w-md bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg shadow-lg z-50';
            successDiv.innerHTML = `
                <div class="flex items-center">
                    <span class="material-symbols-outlined text-green-600 text-sm mr-3">check_circle</span>
                    <span class="text-sm">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-green-400 hover:text-green-600">
                        <span class="material-symbols-outlined text-sm">close</span>
                    </button>
                </div>
            `;
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentElement) {
                    successDiv.style.transform = 'translateX(100%)';
                    setTimeout(() => successDiv.remove(), 300);
                }
            }, duration);
        }
        
        // Show loading indicator
        function showLoading(message = 'Loading...') {
            const existingLoading = document.querySelector('.loading-notification');
            if (existingLoading) {
                existingLoading.remove();
            }
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-notification fixed top-4 right-4 max-w-md bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg shadow-lg z-50';
            loadingDiv.innerHTML = `
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"></div>
                    <span class="text-sm">${message}</span>
                </div>
            `;
            
            document.body.appendChild(loadingDiv);
            return loadingDiv;
        }
        
        // Hide loading indicator
        function hideLoading() {
            const existingLoading = document.querySelector('.loading-notification');
            if (existingLoading) {
                existingLoading.remove();
            }
        }
    </script>
</body>
</html>