<script>
/**
 * EventTypeHandlers Service for Explico Learning
 * Handles different hotspot event types and their specific behaviors
 */
var EventTypeHandlers = (function() {
  function EventTypeHandlers(options) {
    options = options || {};
    this.options = {
      animationDuration: 300,
      zoomTransitionDuration: 500,
      spotlightFadeDuration: 200
    };
    this.options = Object.assign(this.options, options);

    this.activeEvents = {}; // Replaced Map
    this.animationFrames = {}; // Replaced Map
    this.eventListeners = {}; // Replaced Map
  }

  EventTypeHandlers.prototype.handleHotspotEvent = function(hotspot, canvas, hotspotElement) {
    this.clearActiveEvent(hotspot.id);

    try {
      switch (hotspot.eventType) {
        case EVENT_TYPES.TEXT_ON_IMAGE:
          this.handleTextOnImage(hotspot, canvas, hotspotElement);
          break;
        case EVENT_TYPES.TEXT_POPUP:
          this.handleTextPopup(hotspot, canvas, hotspotElement);
          break;
        case EVENT_TYPES.PAN_ZOOM:
          this.handlePanZoom(hotspot, canvas, hotspotElement);
          break;
        case EVENT_TYPES.SPOTLIGHT:
          this.handleSpotlight(hotspot, canvas, hotspotElement);
          break;
        default:
          console.warn('Unknown event type: ' + hotspot.eventType);
      }
    } catch (error) {
      console.error('Error handling hotspot event:', error);
    }
  };

  EventTypeHandlers.prototype.handleTextOnImage = function(hotspot, canvas, hotspotElement) {
    this.clearTooltipForHotspot(hotspot.id);
    var tooltip = this.createTooltip(hotspot);
    this.positionTooltip(tooltip, hotspotElement, hotspot.tooltipPosition);
    canvas.appendChild(tooltip);
    this.animateTooltipIn(tooltip);

    var self = this;
    this.activeEvents[hotspot.id] = {
      type: EVENT_TYPES.TEXT_ON_IMAGE,
      elements: [tooltip],
      cleanup: function() { self.cleanupTextTooltip(tooltip); }
    };

    if (hotspot.autoHideDelay) {
      setTimeout(function() {
        self.clearActiveEvent(hotspot.id);
      }, hotspot.autoHideDelay);
    }
  };

  EventTypeHandlers.prototype.handleTextPopup = function(hotspot, canvas, hotspotElement) {
    var overlay = this.createModalOverlay();
    var popup = this.createTextPopup(hotspot);
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
    this.animatePopupIn(overlay, popup);

    var self = this;
    this.activeEvents[hotspot.id] = {
      type: EVENT_TYPES.TEXT_POPUP,
      elements: [overlay],
      cleanup: function() { self.cleanupTextPopup(overlay); }
    };

    this.addPopupCloseHandlers(overlay, hotspot.id);
  };

  EventTypeHandlers.prototype.handlePanZoom = function(hotspot, canvas, hotspotElement) {
    var backgroundElement = canvas.querySelector('.background-image, .background-video, .background-youtube');
    if (!backgroundElement) return;

    var zoomLevel = hotspot.zoomLevel || 1.5;
    var panOffset = hotspot.panOffset || { x: -9, y: -15 };
    var originalTransform = backgroundElement.style.transform;

    backgroundElement.style.transition = 'transform ' + this.options.zoomTransitionDuration + 'ms ease-in-out';
    backgroundElement.style.transform = 'scale(' + zoomLevel + ') translate(' + panOffset.x + '%, ' + panOffset.y + '%)';

    var bannerElement = null;
    if (hotspot.bannerText) {
      bannerElement = this.createBannerOverlay(hotspot.bannerText);
      canvas.appendChild(bannerElement);
      this.animateBannerIn(bannerElement);
    }

    var self = this;
    this.activeEvents[hotspot.id] = {
      type: EVENT_TYPES.PAN_ZOOM,
      elements: bannerElement ? [bannerElement] : [],
      originalTransform: originalTransform,
      backgroundElement: backgroundElement,
      cleanup: function() { self.cleanupPanZoom(backgroundElement, originalTransform, bannerElement); }
    };
  };

  EventTypeHandlers.prototype.handleSpotlight = function(hotspot, canvas, hotspotElement) {
    var spotlightOverlay = this.createSpotlightOverlay(hotspot, hotspotElement);
    canvas.appendChild(spotlightOverlay);
    this.animateSpotlightIn(spotlightOverlay);

    var self = this;
    this.activeEvents[hotspot.id] = {
      type: EVENT_TYPES.SPOTLIGHT,
      elements: [spotlightOverlay],
      cleanup: function() { self.cleanupSpotlight(spotlightOverlay); }
    };

    spotlightOverlay.addEventListener('click', function() {
      self.clearActiveEvent(hotspot.id);
    });
  };

  EventTypeHandlers.prototype.createTooltip = function(hotspot) {
    var tooltip = document.createElement('div');
    tooltip.className = 'hotspot-tooltip absolute z-[' + UI_CONFIG.Z_INDEX.TOOLTIP + '] bg-gray-900/90 text-white text-sm rounded-md px-3 py-2 shadow-lg max-w-xs pointer-events-none';
    tooltip.dataset.hotspotId = hotspot.id;
    if (hotspot.tooltipContent) {
      tooltip.textContent = hotspot.tooltipContent;
    }
    this.addTooltipArrow(tooltip, hotspot.tooltipPosition);
    return tooltip;
  };

  EventTypeHandlers.prototype.positionTooltip = function(tooltip, hotspotElement, position) {
    position = position || TOOLTIP_POSITIONS.BOTTOM;
    var hotspotRect = hotspotElement.getBoundingClientRect();
    var canvasRect = hotspotElement.closest('.main-canvas').getBoundingClientRect();
    var relativeX = hotspotRect.left - canvasRect.left + hotspotRect.width / 2;
    var relativeY = hotspotRect.top - canvasRect.top + hotspotRect.height / 2;

    switch (position) {
      case TOOLTIP_POSITIONS.TOP:
        tooltip.style.left = relativeX + 'px';
        tooltip.style.bottom = (canvasRect.height - relativeY + hotspotRect.height / 2 + 8) + 'px';
        tooltip.style.transform = 'translateX(-50%)';
        break;
      case TOOLTIP_POSITIONS.BOTTOM:
        tooltip.style.left = relativeX + 'px';
        tooltip.style.top = (relativeY + hotspotRect.height / 2 + 8) + 'px';
        tooltip.style.transform = 'translateX(-50%)';
        break;
      case TOOLTIP_POSITIONS.LEFT:
        tooltip.style.right = (canvasRect.width - relativeX + hotspotRect.width / 2 + 8) + 'px';
        tooltip.style.top = relativeY + 'px';
        tooltip.style.transform = 'translateY(-50%)';
        break;
      case TOOLTIP_POSITIONS.RIGHT:
        tooltip.style.left = (relativeX + hotspotRect.width / 2 + 8) + 'px';
        tooltip.style.top = relativeY + 'px';
        tooltip.style.transform = 'translateY(-50%)';
        break;
    }
  };

  EventTypeHandlers.prototype.addTooltipArrow = function(tooltip, position) {
    var arrow = document.createElement('div');
    arrow.className = 'tooltip-arrow absolute';
    switch (position) {
      case TOOLTIP_POSITIONS.TOP:
        arrow.className += ' top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-900/90';
        break;
      case TOOLTIP_POSITIONS.BOTTOM:
        arrow.className += ' bottom-full left-1/2 -translate-x-1/2 border-4 border-transparent border-b-gray-900/90';
        break;
      case TOOLTIP_POSITIONS.LEFT:
        arrow.className += ' left-full top-1/2 -translate-y-1/2 border-4 border-transparent border-l-gray-900/90';
        break;
      case TOOLTIP_POSITIONS.RIGHT:
        arrow.className += ' right-full top-1/2 -translate-y-1/2 border-4 border-transparent border-r-gray-900/90';
        break;
    }
    tooltip.appendChild(arrow);
  };

  EventTypeHandlers.prototype.createModalOverlay = function() {
    var overlay = document.createElement('div');
    overlay.className = 'modal-overlay fixed inset-0 bg-black/80 z-[' + UI_CONFIG.Z_INDEX.MODAL + '] flex items-center justify-center';
    overlay.style.opacity = '0';
    return overlay;
  };

  EventTypeHandlers.prototype.createTextPopup = function(hotspot) {
    var popup = document.createElement('div');
    popup.className = 'text-popup bg-white rounded-lg shadow-xl max-w-md mx-4 transform scale-90';
    var header = document.createElement('div');
    header.className = 'popup-header flex items-center justify-between p-4 border-b border-gray-200';
    var title = document.createElement('h3');
    title.className = 'text-lg font-semibold text-gray-900';
    title.textContent = hotspot.name || 'Information';
    var closeButton = document.createElement('button');
    closeButton.className = 'text-gray-400 hover:text-gray-600 transition-colors';
    closeButton.innerHTML = '<span class="material-symbols-outlined">close</span>';
    var self = this;
    closeButton.onclick = function() { self.clearActiveEvent(hotspot.id); };
    header.appendChild(title);
    header.appendChild(closeButton);
    var content = document.createElement('div');
    content.className = 'popup-content p-4';
    content.textContent = hotspot.tooltipContent || 'No content provided.';
    popup.appendChild(header);
    popup.appendChild(content);
    return popup;
  };
  
  EventTypeHandlers.prototype.createBannerOverlay = function(text) {
    var banner = document.createElement('div');
    banner.className = 'banner-overlay absolute bottom-10 left-1/2 -translate-x-1/2 bg-gray-900/80 text-white text-sm rounded-md px-3 py-2 shadow-lg max-w-xs text-center';
    banner.textContent = text;
    banner.style.opacity = '0';
    banner.style.transform = 'translateX(-50%) translateY(10px)';
    return banner;
  };

  EventTypeHandlers.prototype.createSpotlightOverlay = function(hotspot, hotspotElement) {
    var overlay = document.createElement('div');
    overlay.className = 'spotlight-overlay absolute inset-0 pointer-events-auto z-[' + UI_CONFIG.Z_INDEX.MODAL + ']';
    overlay.style.opacity = '0';
    var hotspotRect = hotspotElement.getBoundingClientRect();
    var canvasRect = hotspotElement.closest('.main-canvas').getBoundingClientRect();
    var spotlightSize = hotspot.spotlightSize || 200;
    var centerX = hotspotRect.left - canvasRect.left + hotspotRect.width / 2;
    var centerY = hotspotRect.top - canvasRect.top + hotspotRect.height / 2;
    var intensity = hotspot.spotlightIntensity || 0.8;
    overlay.style.background = 'radial-gradient(circle at ' + centerX + 'px ' + centerY + 'px, transparent ' + (spotlightSize / 2) + 'px, rgba(0,0,0,' + intensity + ') ' + spotlightSize + 'px)';
    return overlay;
  };

  EventTypeHandlers.prototype.animateTooltipIn = function(tooltip) {
    var self = this;
    tooltip.style.opacity = '0';
    tooltip.style.transform += ' scale(0.9)';
    requestAnimationFrame(function() {
      tooltip.style.transition = 'opacity ' + self.options.animationDuration + 'ms ease, transform ' + self.options.animationDuration + 'ms ease';
      tooltip.style.opacity = '1';
      tooltip.style.transform = tooltip.style.transform.replace('scale(0.9)', 'scale(1)');
    });
  };

  EventTypeHandlers.prototype.animatePopupIn = function(overlay, popup) {
    var self = this;
    requestAnimationFrame(function() {
      overlay.style.transition = 'opacity ' + self.options.animationDuration + 'ms ease';
      popup.style.transition = 'transform ' + self.options.animationDuration + 'ms ease';
      overlay.style.opacity = '1';
      popup.style.transform = 'scale(1)';
    });
  };

  EventTypeHandlers.prototype.animateBannerIn = function(banner) {
    var self = this;
    requestAnimationFrame(function() {
      banner.style.transition = 'opacity ' + self.options.animationDuration + 'ms ease, transform ' + self.options.animationDuration + 'ms ease';
      banner.style.opacity = '1';
      banner.style.transform = 'translateX(-50%) translateY(0)';
    });
  };

  EventTypeHandlers.prototype.animateSpotlightIn = function(spotlight) {
    var self = this;
    requestAnimationFrame(function() {
      spotlight.style.transition = 'opacity ' + self.options.spotlightFadeDuration + 'ms ease';
      spotlight.style.opacity = '1';
    });
  };

  EventTypeHandlers.prototype.addPopupCloseHandlers = function(overlay, hotspotId) {
    var self = this;
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        self.clearActiveEvent(hotspotId);
      }
    });
    var escapeHandler = function(e) {
      if (e.key === 'Escape') {
        self.clearActiveEvent(hotspotId);
        document.removeEventListener('keydown', escapeHandler);
      }
    };
    document.addEventListener('keydown', escapeHandler);
  };

  EventTypeHandlers.prototype.clearTooltipForHotspot = function(hotspotId) {
    var existingTooltip = document.querySelector('.hotspot-tooltip[data-hotspot-id="' + hotspotId + '"]');
    if (existingTooltip) {
      existingTooltip.remove();
    }
  };

  EventTypeHandlers.prototype.clearActiveEvent = function(hotspotId) {
    var activeEvent = this.activeEvents[hotspotId];
    if (!activeEvent) return;

    if (activeEvent.cleanup) {
      activeEvent.cleanup();
    }

    delete this.activeEvents[hotspotId];
  };

  EventTypeHandlers.prototype.clearAllActiveEvents = function() {
    for (var hotspotId in this.activeEvents) {
        if(this.activeEvents.hasOwnProperty(hotspotId)) {
            this.clearActiveEvent(hotspotId);
        }
    }
  };
  
  EventTypeHandlers.prototype.cleanupTextTooltip = function(tooltip) {
      var self = this;
    if (tooltip && tooltip.parentNode) {
      tooltip.style.transition = 'opacity ' + self.options.animationDuration + 'ms ease, transform ' + self.options.animationDuration + 'ms ease';
      tooltip.style.opacity = '0';
      tooltip.style.transform += ' scale(0.9)';
      setTimeout(function() {
        if (tooltip.parentNode) {
          tooltip.remove();
        }
      }, self.options.animationDuration);
    }
  };

  EventTypeHandlers.prototype.cleanupTextPopup = function(overlay) {
      var self = this;
    if (overlay && overlay.parentNode) {
      var popup = overlay.querySelector('.text-popup');
      overlay.style.transition = 'opacity ' + self.options.animationDuration + 'ms ease';
      if (popup) {
        popup.style.transition = 'transform ' + self.options.animationDuration + 'ms ease';
        popup.style.transform = 'scale(0.9)';
      }
      overlay.style.opacity = '0';
      setTimeout(function() {
        if (overlay.parentNode) {
          overlay.remove();
        }
      }, self.options.animationDuration);
    }
  };

  EventTypeHandlers.prototype.cleanupPanZoom = function(backgroundElement, originalTransform, bannerElement) {
      var self = this;
    if (backgroundElement) {
      backgroundElement.style.transform = originalTransform;
      setTimeout(function() {
        backgroundElement.style.transition = '';
      }, self.options.zoomTransitionDuration);
    }
    if (bannerElement && bannerElement.parentNode) {
      bannerElement.style.transition = 'opacity ' + self.options.animationDuration + 'ms ease, transform ' + self.options.animationDuration + 'ms ease';
      bannerElement.style.opacity = '0';
      bannerElement.style.transform += ' translateY(10px)';
      setTimeout(function() {
        if (bannerElement.parentNode) {
          bannerElement.remove();
        }
      }, self.options.animationDuration);
    }
  };

  EventTypeHandlers.prototype.cleanupSpotlight = function(spotlightOverlay) {
      var self = this;
    if (spotlightOverlay && spotlightOverlay.parentNode) {
      spotlightOverlay.style.transition = 'opacity ' + self.options.spotlightFadeDuration + 'ms ease';
      spotlightOverlay.style.opacity = '0';
      setTimeout(function() {
        if (spotlightOverlay.parentNode) {
          spotlightOverlay.remove();
        }
      }, self.options.spotlightFadeDuration);
    }
  };

  EventTypeHandlers.prototype.getActiveEvent = function(hotspotId) {
    return this.activeEvents[hotspotId] || null;
  };

  EventTypeHandlers.prototype.hasActiveEvent = function(hotspotId) {
    return this.activeEvents.hasOwnProperty(hotspotId);
  };

  EventTypeHandlers.prototype.getAllActiveEvents = function() {
    return Object.assign({}, this.activeEvents);
  };

  EventTypeHandlers.prototype.setAnimationOptions = function(options) {
    this.options = Object.assign({}, this.options, options);
  };

  EventTypeHandlers.prototype.destroy = function() {
    this.clearAllActiveEvents();
    this.animationFrames = {};
    this.eventListeners = {};
  };

  return new EventTypeHandlers();
})();
</script>